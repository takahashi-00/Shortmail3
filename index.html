<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アフター点検メール作成ツール</title>
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- アイコンライブラリ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 日本語フォント (Noto Sans JP) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen selection:bg-blue-100">

    <!-- ヘッダー -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-blue-600 to-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-blue-500/30">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight leading-none">After Support Mailer</h1>
                    <p class="text-xs text-slate-500 font-medium mt-1">桧家住宅 埼玉北工事部 専用ツール</p>
                </div>
            </div>
            <button onclick="window.location.reload()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-2 rounded-full transition-all" title="リセット">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 lg:py-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 左カラム：入力フォーム -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- 基本情報カード -->
            <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50/50 px-6 py-4 border-b border-blue-100/50 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full ring-4 ring-blue-100"></span>
                    <h2 class="text-base font-bold text-slate-700">基本情報設定</h2>
                </div>
                
                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 顧客名 -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">顧客名 <span class="text-red-400">*</span></label>
                            <div class="relative group">
                                <i data-lucide="user" class="absolute left-3 top-2.5 text-slate-400 w-5 h-5 group-focus-within:text-blue-500 transition-colors"></i>
                                <input type="text" id="customerName" placeholder="例：山田 太郎" 
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400"
                                    oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- 担当者名 -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">担当者名</label>
                            <div class="relative group">
                                <i data-lucide="briefcase" class="absolute left-3 top-2.5 text-slate-400 w-5 h-5 group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" id="staffName" value="畑" placeholder="担当者名"
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all"
                                    oninput="updatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- 点検種別 -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">点検種別</label>
                        <div class="relative">
                            <select id="inspectionType" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none appearance-none cursor-pointer transition-all"
                                onchange="toggleCustomInspection(); updatePreview()">
                                <option value="6か月">6か月点検</option>
                                <option value="2年">2年点検</option>
                                <option value="その他">その他（手入力）</option>
                            </select>
                            <div class="absolute right-3 top-3 pointer-events-none text-slate-400">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                        
                        <!-- その他入力用 -->
                        <div id="customInspectionWrapper" class="hidden mt-2">
                            <input type="text" id="customInspectionType" placeholder="例：1年点検、臨時点検など"
                                class="w-full px-4 py-2.5 bg-white border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all"
                                oninput="updatePreview()">
                        </div>
                    </div>

                    <!-- 不具合内容 -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">不具合・指摘内容</label>
                        <div class="relative group">
                            <i data-lucide="alert-triangle" class="absolute left-3 top-3 text-slate-400 w-5 h-5 group-focus-within:text-amber-500 transition-colors"></i>
                            <textarea id="issueDetail" placeholder="例：クロスの剥がれ、建具の調整" rows="3"
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 outline-none transition-all resize-none"
                                oninput="updatePreview()"></textarea>
                        </div>
                    </div>

                    <!-- お詫びフラグ -->
                    <div class="flex items-center justify-between bg-orange-50/50 p-4 rounded-xl border border-orange-100 transition-colors hover:bg-orange-50">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-orange-900">お詫び文を挿入</div>
                                <div class="text-xs text-orange-700/70">対応が遅れた場合などに使用</div>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="needsApology" class="sr-only peer" onchange="updatePreview()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:shadow-sm after:transition-all peer-checked:bg-orange-500"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 訪問・日程調整カード -->
            <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50/50 px-6 py-4 border-b border-emerald-100/50 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full ring-4 ring-emerald-100"></span>
                    <h2 class="text-base font-bold text-slate-700">訪問・日程調整</h2>
                </div>

                <div class="p-6 space-y-6">
                    <!-- 訪問理由 -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">訪問理由</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer relative">
                                <input type="radio" name="visitReason" value="修繕作業" checked class="peer hidden" onchange="updatePreview()">
                                <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white border-slate-100 text-slate-500 peer-checked:bg-blue-50/50 peer-checked:border-blue-500 peer-checked:text-blue-700 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 flex items-center justify-center gap-2">
                                    <i data-lucide="briefcase" class="w-4 h-4"></i> 修繕作業
                                </div>
                            </label>
                            <label class="cursor-pointer relative">
                                <input type="radio" name="visitReason" value="現地調査" class="peer hidden" onchange="updatePreview()">
                                <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white border-slate-100 text-slate-500 peer-checked:bg-emerald-50/50 peer-checked:border-emerald-500 peer-checked:text-emerald-700 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 flex items-center justify-center gap-2">
                                    <i data-lucide="file-text" class="w-4 h-4"></i> 現地調査
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 候補日入力エリア -->
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-end mb-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">こちらからの候補日</label>
                            <button onclick="clearCandidates()" id="clearBtn" class="hidden text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-red-50">
                                <i data-lucide="x" class="w-3 h-3"></i> 全てクリア
                            </button>
                        </div>
                        
                        <!-- カレンダーツール -->
                        <div class="flex flex-wrap items-end gap-2 mb-3 p-3 bg-slate-50/80 rounded-xl border border-slate-200">
                            <div class="flex-1 min-w-[140px]">
                                <label class="text-[10px] font-semibold text-slate-400 mb-1 block uppercase">日付</label>
                                <input type="date" id="dateInput" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                            </div>
                            <div class="w-[110px]">
                                <label class="text-[10px] font-semibold text-slate-400 mb-1 block uppercase">開始時間</label>
                                <div class="relative">
                                    <i data-lucide="clock" class="absolute left-2.5 top-2.5 text-slate-400 pointer-events-none w-3.5 h-3.5"></i>
                                    <select id="timeInput" class="w-full pl-8 pr-2 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none appearance-none cursor-pointer">
                                        <option value="09:00">09:00</option>
                                        <option value="09:30">09:30</option>
                                        <option value="10:00" selected>10:00</option>
                                        <option value="10:30">10:30</option>
                                        <option value="11:00">11:00</option>
                                        <option value="11:30">11:30</option>
                                        <option value="13:00">13:00</option>
                                        <option value="13:30">13:30</option>
                                        <option value="14:00">14:00</option>
                                        <option value="14:30">14:30</option>
                                        <option value="15:00">15:00</option>
                                        <option value="15:30">15:30</option>
                                        <option value="16:00">16:00</option>
                                        <option value="16:30">16:30</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="addCandidateDate()" id="addBtn" disabled class="h-[38px] px-4 bg-slate-800 text-white rounded-lg text-sm font-medium hover:bg-slate-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5 shadow-md shadow-slate-200 active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4"></i> 追加
                            </button>
                        </div>

                        <div class="relative group">
                            <textarea id="candidateDates" rows="4" placeholder="上部のツールから日時を追加するか、ここに直接入力してください&#13;&#10;（空欄の場合：相手に都合を伺う文章になります）"
                                class="w-full p-4 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all font-mono text-sm shadow-sm"
                                oninput="updatePreview(); toggleClearBtn()"></textarea>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            定休日（火・水）と営業時間（9-17時）の注釈は自動で追加されます。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右カラム：プレビュー -->
        <div class="lg:col-span-5 space-y-6">
            <div class="lg:sticky lg:top-28 space-y-4">
                <div class="flex items-center justify-between px-1">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        プレビュー
                    </h2>
                    <span id="nameAlert" class="text-xs font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-full animate-pulse">
                        顧客名を入力してください
                    </span>
                </div>

                <div class="relative group">
                    <!-- 装飾的な背景要素 -->
                    <div class="absolute -inset-1 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl opacity-10 blur group-hover:opacity-20 transition duration-1000"></div>
                    
                    <div class="relative bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden">
                        <!-- プレビューヘッダー -->
                        <div class="bg-slate-50 border-b border-slate-100 px-4 py-2 flex items-center gap-2">
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-rose-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-400"></div>
                            </div>
                            <div class="ml-2 text-xs text-slate-400 font-mono">Message Preview</div>
                        </div>

                        <textarea id="generatedText" readonly
                            class="w-full h-[600px] p-6 bg-white resize-none font-mono text-sm leading-relaxed focus:outline-none text-slate-700 selection:bg-blue-100"></textarea>
                    </div>
                    
                    <!-- コピーボタン（フローティング） -->
                    <div class="absolute bottom-6 right-6">
                        <button onclick="handleCopy()" id="copyBtn" disabled
                            class="flex items-center gap-2 px-5 py-3 rounded-full font-bold shadow-lg shadow-blue-500/20 transition-all transform hover:-translate-y-1 active:scale-95 bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:shadow-xl hover:shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none grayscale disabled:grayscale">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="tracking-wide" id="copyBtnText">COPY TEXT</span>
                        </button>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-[10px] text-slate-400 font-medium tracking-widest uppercase opacity-60">
                        Hinokiya Housing Saitama North Construction Dept.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 初期化：アイコンの描画
        lucide.createIcons();

        // 状態の管理
        let copied = false;

        // 日付入力の監視（追加ボタンの有効化）
        document.getElementById('dateInput').addEventListener('input', (e) => {
            const btn = document.getElementById('addBtn');
            btn.disabled = !e.target.value;
            if(!e.target.value) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // プレビュー更新メイン関数
        function updatePreview() {
            // 値の取得
            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            
            // 点検種別
            const inspectionTypeSelect = document.getElementById('inspectionType').value;
            const customInspectionType = document.getElementById('customInspectionType').value;
            let type = inspectionTypeSelect === 'その他' ? customInspectionType : inspectionTypeSelect;
            type = type.trim();
            if (type && !type.includes('点検')) type += '点検';

            // その他の値
            const issueDetail = document.getElementById('issueDetail').value;
            const needsApology = document.getElementById('needsApology').checked;
            const visitReason = document.querySelector('input[name="visitReason"]:checked').value;
            const candidateDates = document.getElementById('candidateDates').value;

            // バリデーションアラート制御
            const nameAlert = document.getElementById('nameAlert');
            const copyBtn = document.getElementById('copyBtn');
            if (customerName) {
                nameAlert.style.display = 'none';
                copyBtn.disabled = false;
                copyBtn.classList.remove('grayscale');
            } else {
                nameAlert.style.display = 'block';
                copyBtn.disabled = true;
                copyBtn.classList.add('grayscale');
            }

            // 文章生成
            const greeting = `いつも大変お世話になっております。\n桧家住宅 埼玉北工事部の${staffName}です。`;

            let mainBody = '';
            if (type) {
                mainBody += `先日は、${type}にお立会いいただきありがとうございました。\n`;
            }

            if (issueDetail) {
                mainBody += `ご指摘いただきました「${issueDetail}」の件についてご連絡いたしました。\n`;
                if (needsApology) {
                    mainBody += `点検日からお時間をいただいてしまい、誠に申し訳ございません。\n`;
                }
            }

            let proposal = '';
            const reasonText = visitReason === '現地調査' ? '状況確認（現地調査）' : '修繕作業';
            proposal += `つきましては、下記日程にて${reasonText}にお伺いしたく存じます。\n\n`;

            if (candidateDates.trim()) {
                proposal += `【候補日時】\n${candidateDates.trim()}\n\n`;
                proposal += `上記以外でも、火・水を除く平日・土日の9時～17時の間で調整可能です。\nご都合はいかがでしょうか。`;
            } else {
                proposal += `恐れ入りますが、火・水を除く平日・土日の9時～17時の間で、\nご都合のよろしい日程を3つほどお知らせいただけますでしょうか。`;
            }

            const fullText = `${customerName} 様\n\n${greeting}\n\n${mainBody}\n${proposal}\n\n何卒よろしくお願い申し上げます。\n\n桧家住宅 埼玉北工事部 ${staffName}`;

            document.getElementById('generatedText').value = fullText;
        }

        // その他入力フィールドの表示切替
        function toggleCustomInspection() {
            const val = document.getElementById('inspectionType').value;
            const wrapper = document.getElementById('customInspectionWrapper');
            if (val === 'その他') {
                wrapper.classList.remove('hidden');
            } else {
                wrapper.classList.add('hidden');
            }
        }

        // 候補日追加処理
        function addCandidateDate() {
            const dateVal = document.getElementById('dateInput').value;
            const timeVal = document.getElementById('timeInput').value;
            
            if (!dateVal) return;

            const date = new Date(dateVal);
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const formatted = `・${date.getMonth() + 1}月${date.getDate()}日(${days[date.getDay()]}) ${timeVal}～`;

            const area = document.getElementById('candidateDates');
            const current = area.value;
            
            if (current) {
                area.value = current.trim() + '\n' + formatted + '\n';
            } else {
                area.value = formatted + '\n';
            }

            updatePreview();
            toggleClearBtn();
        }

        // クリアボタン表示切替
        function toggleClearBtn() {
            const val = document.getElementById('candidateDates').value;
            const btn = document.getElementById('clearBtn');
            if (val) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        // 候補日クリア
        function clearCandidates() {
            document.getElementById('candidateDates').value = '';
            updatePreview();
            toggleClearBtn();
        }

        // コピー機能
        function handleCopy() {
            const text = document.getElementById('generatedText').value;
            
            // execCommand (フォールバック) を使用
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showCopiedState();
            } catch (err) {
                console.error('Copy failed', err);
                // モダンAPIへの再挑戦 (HTTPS環境用)
                navigator.clipboard.writeText(text).then(showCopiedState).catch(e => console.error(e));
            }

            document.body.removeChild(textArea);
        }

        // コピー成功時のUI変更
        function showCopiedState() {
            const btn = document.getElementById('copyBtn');
            const btnText = document.getElementById('copyBtnText');
            const originalClass = btn.className; // 現在のクラスを保持すると複雑になるので上書き制御

            // スタイル変更
            btn.classList.remove('from-blue-600', 'to-indigo-600', 'hover:shadow-blue-500/30');
            btn.classList.add('bg-emerald-500', 'text-white', 'ring-4', 'ring-emerald-100');
            
            // アイコンとテキスト変更
            const icon = btn.querySelector('svg'); // LucideのSVG
            btnText.textContent = "COPIED";
            
            // 2秒後に戻す
            setTimeout(() => {
                btn.classList.remove('bg-emerald-500', 'text-white', 'ring-4', 'ring-emerald-100');
                btn.classList.add('from-blue-600', 'to-indigo-600', 'hover:shadow-blue-500/30');
                btnText.textContent = "COPY TEXT";
            }, 2000);
        }

        // 初回実行
        updatePreview();
    </script>
</body>
</html>