<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ•ã‚¿ãƒ¼ç‚¹æ¤œãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'pulse-fast': 'pulseFast 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        },
                        pulseFast: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¨­å®š */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ãƒªãƒ³ã‚°èª¿æ•´ */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }
        
        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bg-animate {
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
            transition: background-image 0.5s ease-in-out;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* macOS Window Buttons */
        .mac-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; position: relative; margin-right: 6px; }
        .mac-close { background-color: #FF5F56; border: 0.5px solid #E0443E; }
        .mac-minimize { background-color: #FFBD2E; border: 0.5px solid #DEA123; }
        .mac-maximize { background-color: #27C93F; border: 0.5px solid #1AAB29; }
    </style>
</head>
<body id="bodyBg" class="bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate">

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleSettingsModal()"></div>
        <div class="relative w-full max-w-md bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-6 border border-white/50 dark:border-slate-700 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-black text-slate-700 dark:text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-pink-500"></i>
                    AIè¨­å®š
                </h3>
                <button onclick="toggleSettingsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Gemini API Key</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-[10px] text-pink-500 hover:text-pink-600 hover:underline flex items-center gap-1 transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                            ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹
                        </a>
                    </div>
                    <input type="password" id="apiKeyInput" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ä¸­ (ä¸Šæ›¸ãã™ã‚‹å ´åˆã¯å…¥åŠ›)" 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">â€»å…¥åŠ›ã—ãªã„å ´åˆã¯å†…è”µã®å…±æœ‰ã‚­ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Model Name</label>
                    <input type="text" id="modelNameInput" value="gemini-3-flash-preview"
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">æ€è€ƒãƒ¬ãƒ™ãƒ«æœ‰åŠ¹ (Gemini 3 Flash Preview)</p>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-gradient-to-r from-pink-500 to-violet-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-500/30 hover:shadow-pink-500/40 active:scale-95 transition-all">
                    è¨­å®šã‚’ä¿å­˜
                </button>
                <button onclick="clearSettings()" class="px-4 py-3.5 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all font-bold text-sm">
                    å‰Šé™¤
                </button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç”¨ãƒˆãƒ¼ã‚¹ãƒˆ -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[110] hidden animate-fade-in">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 border border-white/20 backdrop-blur-md">
            <i data-lucide="info" class="w-4 h-4 text-pink-400"></i>
            <span id="toastText" class="text-sm font-bold">é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
        </div>
    </div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-white/40 dark:border-slate-700/50 sticky top-0 z-50 shadow-sm transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-pink-500 to-violet-500 p-2.5 rounded-2xl text-white shadow-lg shadow-pink-500/30 transform transition-transform hover:scale-110 hover:rotate-3 duration-300">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-violet-600 dark:from-pink-400 dark:to-violet-400 tracking-tight leading-none">After Support Mailer</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold mt-1 tracking-wide">æ¡§å®¶ä½å®… åŸ¼ç‰åŒ—å·¥äº‹éƒ¨</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
                <button onclick="toggleSettingsModal()" class="p-2.5 rounded-full text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-white/60 dark:hover:bg-slate-700 transition-all focus:outline-none focus:ring-2 focus:ring-slate-400/50 active:scale-95" title="APIè¨­å®š">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
                <button onclick="toggleDarkMode()" class="p-2.5 rounded-full text-slate-500 hover:text-violet-600 dark:text-slate-400 dark:hover:text-violet-300 hover:bg-white/60 dark:hover:bg-slate-700 transition-all focus:outline-none focus:ring-2 focus:ring-violet-400/50 active:scale-95" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <!-- ãƒªã‚»ãƒƒãƒˆ -->
                <button onclick="resetForm()" class="p-2.5 rounded-full text-slate-500 hover:text-rose-500 hover:bg-rose-50 dark:text-slate-400 dark:hover:bg-rose-900/20 transition-all focus:outline-none focus:ring-2 focus:ring-rose-400/50 active:scale-95" title="ãƒªã‚»ãƒƒãƒˆ">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 lg:py-10 space-y-6">

        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
        <nav class="grid grid-cols-3 gap-2 sm:gap-4">
            <button onclick="setMode('normal')" id="tabNormal" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/70 dark:bg-slate-800/80 border-pink-500 text-pink-600 dark:text-pink-400 font-bold shadow-sm hover:border-pink-300">
                <span class="text-sm">æ—¥ç¨‹èª¿æ•´ãƒ¡ãƒ¼ãƒ«</span>
            </button>
            <button onclick="setMode('sms')" id="tabSms" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60">
                <span class="text-sm">äº‹å‰ç¢ºèªSMS</span>
            </button>
            <button onclick="setMode('custom')" id="tabCustom" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60">
                <div class="flex items-center gap-1.5">
                    <i data-lucide="sparkles" class="w-4 h-4 text-violet-500 group-hover:scale-110 transition-transform"></i>
                    <span class="text-sm">AIæ–‡ç« ä½œæˆ</span>
                </div>
            </button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- å…±é€šï¼šåŸºæœ¬æƒ…å ±ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
                <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                    <div class="bg-gradient-to-r from-pink-50/80 to-purple-50/80 dark:from-pink-900/20 dark:to-purple-900/20 px-6 py-4 border-b border-pink-100/50 dark:border-pink-800/30 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center text-pink-500 dark:text-pink-300">
                            <i data-lucide="user-circle" class="w-5 h-5"></i>
                        </div>
                        <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">åŸºæœ¬æƒ…å ±è¨­å®š</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- é¡§å®¢å -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-pink-500/80 dark:text-pink-400/80 uppercase tracking-wider ml-1">é¡§å®¢å <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="user" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-pink-500 transition-colors"></i>
                                    <input type="text" id="customerName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" 
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all placeholder:text-slate-400 shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                                </div>
                            </div>

                            <!-- æ‹…å½“è€…å -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-purple-500/80 dark:text-purple-400/80 uppercase tracking-wider ml-1">æ‹…å½“è€…å <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="briefcase" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-purple-500 transition-colors"></i>
                                    <input type="text" id="staffName" value="ç•‘" placeholder="æ‹…å½“è€…å"
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¢ãƒ¼ãƒ‰åˆ¥å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="modeSettingsContainer" class="space-y-6 min-h-[400px]">
                    
                    <!-- 1. é€šå¸¸ãƒ»äº‹å‰ç¢ºèªãƒ¢ãƒ¼ãƒ‰ç”¨è¨­å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º) -->
                    <div id="normalSettings" class="space-y-6 animate-fade-in">
                        
                        <!-- ç‚¹æ¤œè©³ç´°ã‚«ãƒ¼ãƒ‰ (SMSãƒ¢ãƒ¼ãƒ‰æ™‚ã¯éè¡¨ç¤º) -->
                        <div id="inspectionDetailsCard" class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-blue-50/80 to-cyan-50/80 dark:from-blue-900/20 dark:to-cyan-900/20 px-6 py-4 border-b border-blue-100/50 dark:border-blue-800/30 flex items-center justify-between">
                                 <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">ç‚¹æ¤œãƒ»ä¸å…·åˆè©³ç´°</h2>
                                </div>
                                <span class="text-[10px] bg-white/80 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold border border-slate-100 dark:border-slate-600">å®šå‹ãƒ¢ãƒ¼ãƒ‰</span>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <!-- ç‚¹æ¤œç¨®åˆ¥ -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-blue-500/80 dark:text-blue-400/80 uppercase tracking-wider ml-1">ç‚¹æ¤œç¨®åˆ¥</label>
                                    <div class="relative">
                                        <select id="inspectionType" class="w-full px-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white appearance-none cursor-pointer transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            onchange="toggleCustomInspection(); updatePreview()">
                                            <option value="6ã‹æœˆ">6ã‹æœˆç‚¹æ¤œ</option>
                                            <option value="2å¹´">2å¹´ç‚¹æ¤œ</option>
                                            <option value="ãã®ä»–">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</option>
                                        </select>
                                        <div class="absolute right-3 top-3 pointer-events-none text-slate-400">
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                    <div id="customInspectionWrapper" class="hidden mt-2">
                                        <input type="text" id="customInspectionType" placeholder="ä¾‹ï¼š1å¹´ç‚¹æ¤œã€è‡¨æ™‚ç‚¹æ¤œãªã©"
                                            class="w-full px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all"
                                            oninput="updatePreview()">
                                    </div>
                                </div>

                                <!-- ä¸å…·åˆå†…å®¹ -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-amber-500/80 dark:text-amber-400/80 uppercase tracking-wider ml-1">ä¸å…·åˆãƒ»æŒ‡æ‘˜å†…å®¹</label>
                                    <div class="relative group">
                                        <i data-lucide="alert-triangle" class="absolute left-3 top-3 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-amber-500 transition-colors"></i>
                                        <textarea id="issueDetail" placeholder="ä¾‹ï¼šã‚¯ãƒ­ã‚¹ã®å‰¥ãŒã‚Œã€å»ºå…·ã®èª¿æ•´" rows="3"
                                            class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white resize-none transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            oninput="updatePreview()"></textarea>
                                    </div>
                                </div>

                                <!-- ãŠè©«ã³ãƒ•ãƒ©ã‚° -->
                                <div class="flex items-center justify-between bg-orange-50/60 dark:bg-orange-900/20 p-3 rounded-xl border border-orange-100 dark:border-orange-800/30 transition-colors hover:bg-orange-50 dark:hover:bg-orange-900/30 group cursor-pointer" onclick="document.getElementById('needsApology').click()">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white dark:bg-orange-900/40 p-2 rounded-lg text-orange-500 dark:text-orange-400 shadow-sm">
                                            <i data-lucide="heart-handshake" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-orange-900 dark:text-orange-200">ãŠè©«ã³æ–‡ã‚’æŒ¿å…¥</div>
                                            <div class="text-xs text-orange-700/70 dark:text-orange-300/60">é…å»¶æ™‚ãªã©ã«ä½¿ç”¨</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer pointer-events-none">
                                        <input type="checkbox" id="needsApology" class="sr-only peer" onchange="updatePreview()">
                                        <div class="w-10 h-6 bg-slate-300 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:shadow-sm after:transition-all peer-checked:bg-orange-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- è¨ªå•ãƒ»æ—¥ç¨‹èª¿æ•´ã‚«ãƒ¼ãƒ‰ -->
                        <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-emerald-50/80 to-teal-50/80 dark:from-emerald-900/20 dark:to-teal-900/20 px-6 py-4 border-b border-emerald-100/50 dark:border-emerald-800/30 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center text-emerald-500 dark:text-emerald-300">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                </div>
                                <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">è¨ªå•ãƒ»æ—¥ç¨‹èª¿æ•´</h2>
                            </div>

                            <div class="p-6 space-y-6">
                                <!-- è¨ªå•ç†ç”± -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">è¨ªå•ç†ç”±</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="ä¿®ç¹•ä½œæ¥­" checked class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-blue-50/90 dark:peer-checked:bg-blue-900/40 peer-checked:border-blue-500 dark:peer-checked:border-blue-400 peer-checked:text-blue-600 dark:peer-checked:text-blue-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="wrench" class="w-4 h-4"></i> ä¿®ç¹•ä½œæ¥­
                                            </div>
                                        </label>
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="ç¾åœ°èª¿æŸ»" class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-emerald-50/90 dark:peer-checked:bg-emerald-900/40 peer-checked:border-emerald-500 dark:peer-checked:border-emerald-400 peer-checked:text-emerald-600 dark:peer-checked:text-emerald-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="search" class="w-4 h-4"></i> ç¾åœ°èª¿æŸ»
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- å€™è£œæ—¥å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-end mb-1">
                                        <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">æ—¥æ™‚è¨­å®š</label>
                                        <button onclick="clearCandidates()" id="clearBtn" class="hidden text-xs text-rose-400 hover:text-rose-600 flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-rose-50 dark:hover:bg-rose-900/20 font-bold">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> ã‚¯ãƒªã‚¢
                                        </button>
                                    </div>
                                    
                                    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ„ãƒ¼ãƒ«ï¼ˆ15åˆ†åˆ»ã¿ï¼‹çµ‚äº†æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ -->
                                    <div class="flex flex-wrap items-end gap-2 mb-3 p-3 bg-white/50 dark:bg-slate-700/30 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm">
                                        <div class="flex-1 min-w-[130px]">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">æ—¥ä»˜</label>
                                            <input type="date" id="dateInput" class="w-full px-3 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white transition-all focus:ring-2 focus:ring-emerald-500/50">
                                        </div>
                                        
                                        <div class="w-full sm:w-auto">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">æ™‚é–“</label>
                                            <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                                                <div class="relative min-w-[90px]">
                                                    <select id="timeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                        <!-- JSã§ç”Ÿæˆ -->
                                                    </select>
                                                    <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                </div>

                                                <!-- çµ‚äº†æ™‚é–“ã‚¨ãƒªã‚¢ -->
                                                <div class="flex items-center gap-2" id="endTimeArea">
                                                    <span class="text-slate-400 text-sm hidden" id="tilde">ï½</span>
                                                    <div class="relative min-w-[90px] hidden" id="endTimeWrapper">
                                                        <select id="endTimeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                            <!-- JSã§ç”Ÿæˆ -->
                                                        </select>
                                                        <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                    </div>
                                                    
                                                    <label class="cursor-pointer select-none">
                                                        <input type="checkbox" id="useEndTime" class="sr-only peer" onchange="toggleEndTime()">
                                                        <span class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-1.5 rounded hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors peer-checked:hidden flex items-center gap-1">
                                                            <i data-lucide="clock" class="w-3 h-3"></i> çµ‚äº†æ™‚é–“
                                                        </span>
                                                        <span class="hidden peer-checked:flex text-slate-400 hover:text-slate-600 cursor-pointer p-1">
                                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <button onclick="addCandidateDate()" id="addBtn" disabled class="h-[38px] px-3 bg-slate-800 dark:bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 dark:hover:bg-emerald-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 shadow-md active:scale-95 ml-auto sm:ml-0">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>

                                    <textarea id="candidateDates" rows="4" placeholder="å€™è£œæ—¥ã€ã¾ãŸã¯ç¢ºå®šæ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                        class="w-full p-4 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-700 dark:text-white font-mono text-sm shadow-sm transition-all placeholder:text-slate-400 focus:bg-white dark:focus:bg-slate-800"
                                        oninput="updatePreview(); toggleClearBtn()"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ç”¨è¨­å®š -->
                    <div id="customSettings" class="hidden space-y-6 animate-fade-in">
                        <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-violet-50/80 to-fuchsia-50/80 dark:from-violet-900/20 dark:to-fuchsia-900/20 px-6 py-4 border-b border-violet-100/50 dark:border-violet-800/30 flex items-center justify-between">
                                 <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-500 dark:text-violet-300">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">AIæ–‡ç« ä½œæˆ</h2>
                                </div>
                            </div>
                            
                            <div class="p-6 space-y-4">
                                <div class="bg-violet-50/60 dark:bg-violet-900/10 p-4 rounded-2xl text-sm text-slate-600 dark:text-slate-300 leading-relaxed border border-violet-100 dark:border-violet-800/30">
                                    <span class="font-bold text-violet-600 dark:text-violet-400 block mb-1">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</span>
                                    AIã«ä½œæˆã•ã›ãŸã„æ–‡ç« ã®è¦ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                                    <br>
                                    <span class="text-xs opacity-75">â€»Enterã‚­ãƒ¼ã§é€ä¿¡ (Shift+Enterã§æ”¹è¡Œ)</span>
                                </div>

                                <!-- è‡ªç”±å…¥åŠ›ç”¨ä»¶ -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-violet-500/80 dark:text-violet-400/80 uppercase tracking-wider ml-1">ä¼ãˆãŸã„è¦ä»¶ï¼ˆãƒ¡ãƒ¢æ›¸ãã§OKï¼‰ <span class="text-rose-500">*</span></label>
                                    <div class="relative group">
                                        <textarea id="customMessage" placeholder="ä¾‹ï¼š&#13;&#10;ãƒ»æ¥é€±ã®æœˆæ›œæ—¥ã«é›»è©±ã—ãŸã„&#13;&#10;ãƒ»æ™‚é–“ã¯10æ™‚ã‹ã‚‰12æ™‚ã®é–“ãŒã„ã„&#13;&#10;ãƒ»éƒ½åˆãŒæ‚ªã‘ã‚Œã°æ•™ãˆã¦ã»ã—ã„" rows="6"
                                            class="w-full p-4 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white resize-none transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm leading-relaxed"
                                            oninput="updatePreview()"></textarea>
                                    </div>
                                    
                                    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
                                    <div class="flex items-center justify-between pt-2">
                                        <!-- Thinking Toggle -->
                                        <label class="flex items-center gap-2 cursor-pointer group/toggle p-1 rounded-lg hover:bg-white/40 dark:hover:bg-black/20 transition-all select-none">
                                            <div class="relative">
                                                <input type="checkbox" id="useThinking" class="sr-only peer" checked>
                                                <div class="w-9 h-5 bg-slate-300 dark:bg-slate-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-500"></div>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider flex items-center gap-1">
                                                    Thinking Mode
                                                    <i data-lucide="brain-circuit" class="w-3 h-3 text-violet-500"></i>
                                                </span>
                                                <span class="text-[10px] text-slate-400 font-medium group-hover/toggle:text-slate-500 transition-colors">ON: æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½¿ã£ã¦ä¸å¯§ã«ç”Ÿæˆ</span>
                                            </div>
                                        </label>

                                        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                                        <button id="aiGenerateBtn" onclick="handleAIGenerate()" class="px-5 py-2.5 bg-gradient-to-r from-violet-600 to-indigo-600 text-white text-sm font-bold rounded-xl shadow-lg hover:shadow-violet-500/40 hover:-translate-y-0.5 active:translate-y-0 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-50 disabled:grayscale disabled:transform-none">
                                            <span class="tracking-wide">AIã§ç”Ÿæˆã™ã‚‹</span>
                                            <i data-lucide="send-horizontal" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="lg:col-span-5 space-y-6 lg:sticky lg:top-[5.5rem] self-start">
                
                <!-- ä¸Šç«¯æƒãˆã®ãŸã‚ã«ã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’å‰Šé™¤ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç›´é…ç½®ã™ã‚‹æ§‹æˆã«å¤‰æ›´ -->
                
                <div class="relative group h-[calc(100vh-140px)] min-h-[500px]">
                    <!-- èƒŒæ™¯ã®è£…é£¾ï¼ˆã‚°ãƒ­ãƒ¼åŠ¹æœï¼‰ -->
                    <div id="previewGlow" class="absolute -inset-1 bg-gradient-to-br from-pink-500 to-violet-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000"></div>
                    
                    <div class="relative bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/60 dark:border-slate-600/50 overflow-hidden transition-colors duration-300 flex flex-col h-full">
                        
                        <!-- Macé¢¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚’çµ±åˆï¼‰ -->
                        <div class="bg-gray-100/80 dark:bg-slate-800/80 border-b border-gray-200 dark:border-slate-700 px-4 py-3 flex items-center justify-between h-12 flex-shrink-0">
                            <div class="flex gap-2 opacity-100 group/btns w-20">
                                <div class="mac-dot mac-close shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-minimize shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-maximize shadow-sm hover:brightness-90 transition-all"></div>
                            </div>
                            
                            <span id="previewLabel" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest select-none truncate">
                                æ—¥ç¨‹èª¿æ•´ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                            </span>

                            <div class="w-20 flex justify-end">
                                <!-- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ã“ã“ã«é…ç½® -->
                                <div id="nameAlert" class="hidden flex items-center gap-1 text-[10px] font-bold text-rose-500 animate-pulse">
                                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                                    <span>å…¥åŠ›å¿…é ˆ</span>
                                </div>
                            </div>
                        </div>

                        <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ (ç·¨é›†å¯èƒ½ã«å¤‰æ›´) -->
                        <div class="flex-1 relative overflow-hidden">
                            <textarea id="generatedText"
                                class="w-full h-full p-6 bg-transparent resize-none font-mono text-sm leading-relaxed focus:outline-none text-slate-700 dark:text-slate-300 selection:bg-pink-100 dark:selection:bg-pink-900/30 overflow-y-auto"></textarea>
                            
                            <!-- AIç”Ÿæˆä¸­ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                            <div id="aiLoading" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4 hidden z-20">
                                <div class="w-10 h-10 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin"></div>
                                <span class="text-xs font-bold text-violet-600 dark:text-violet-400 animate-pulse">AIæ€è€ƒä¸­...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ -->
                    <div class="absolute bottom-6 right-6 z-10">
                        <button onclick="handleCopy()" id="copyBtn" disabled
                            class="flex items-center gap-2 px-6 py-3.5 rounded-full font-bold shadow-lg shadow-pink-500/30 transition-all transform hover:-translate-y-1 active:scale-95 bg-gradient-to-r from-pink-500 to-violet-600 text-white hover:shadow-xl hover:shadow-pink-500/40 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none grayscale disabled:grayscale ring-4 ring-white/30 dark:ring-black/30 backdrop-blur-sm">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="tracking-wide" id="copyBtnText">COPY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let currentMode = 'normal';
        let isGenerating = false;
        const DEFAULT_API_KEY = "AIzaSyBA5ZQXfQTwO_e_BmUeuOkaDyXR8p8ue78"; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼

        // è¨­å®šã®èª­ã¿è¾¼ã¿
        const loadSettings = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            const savedModel = localStorage.getItem('gemini_model_name');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
            if (savedModel) document.getElementById('modelNameInput').value = savedModel;
            
            // AIãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            updateAIBtnState();
        };

        const updateAIBtnState = () => {
            const btn = document.getElementById('aiGenerateBtn');
            const hasKey = !!(localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY);
            if(btn) {
                btn.disabled = !hasKey;
                btn.title = hasKey ? "AIã§ç”Ÿæˆ" : "APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„";
            }
        };

        // è¨­å®šã®ä¿å­˜
        const saveSettings = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelNameInput').value.trim();
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model_name', model);
            showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            toggleSettingsModal();
            updateAIBtnState();
            updatePreview();
        };

        const clearSettings = () => {
            if(!confirm('è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('gemini_model_name');
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('modelNameInput').value = 'gemini-3-flash-preview';
            showToast('è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            updateAIBtnState();
        };

        const toggleSettingsModal = () => {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
        };

        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            document.getElementById('toastText').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        // æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
        const initTimeOptions = () => {
            const timeSelect = document.getElementById('timeInput');
            const endTimeSelect = document.getElementById('endTimeInput');
            let options = '';
            
            // 9:00 - 19:00, 15åˆ†åˆ»ã¿
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break; // 19:00ã¾ã§
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10:00
                    const isSelected = time === '10:00' ? 'selected' : '';
                    options += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            timeSelect.innerHTML = options;
            
            // çµ‚äº†æ™‚é–“ç”¨ (15:00ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
            let endOptions = '';
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break;
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const isSelected = time === '15:00' ? 'selected' : '';
                    endOptions += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            endTimeSelect.innerHTML = endOptions;
        };

        const toggleEndTime = () => {
            const isChecked = document.getElementById('useEndTime').checked;
            const wrapper = document.getElementById('endTimeWrapper');
            const tilde = document.getElementById('tilde');
            
            if (isChecked) {
                wrapper.classList.remove('hidden');
                tilde.classList.remove('hidden');
            } else {
                wrapper.classList.add('hidden');
                tilde.classList.add('hidden');
            }
        };

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ– (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ©ã‚¤ãƒˆ)
        if (localStorage.theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetForm() {
            if (!confirm('å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;

            document.getElementById('customerName').value = '';
            document.getElementById('staffName').value = 'ç•‘'; 
            document.getElementById('inspectionType').value = '6ã‹æœˆ';
            document.getElementById('customInspectionType').value = '';
            document.getElementById('issueDetail').value = '';
            document.getElementById('needsApology').checked = false;
            
            const visitRadios = document.getElementsByName('visitReason');
            for(const r of visitRadios) {
                if(r.value === 'ä¿®ç¹•ä½œæ¥­') r.checked = true;
            }

            document.getElementById('dateInput').value = '';
            // æ™‚åˆ»ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('timeInput').value = '10:00';
            document.getElementById('endTimeInput').value = '15:00';
            document.getElementById('useEndTime').checked = false;
            toggleEndTime();

            document.getElementById('candidateDates').value = '';
            document.getElementById('customMessage').value = '';

            document.getElementById('customInspectionWrapper').classList.add('hidden');
            toggleClearBtn();
            setMode('normal');
            updatePreview();
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function setMode(mode) {
            currentMode = mode;
            
            const activeClass = "group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/70 dark:bg-slate-800/80 font-bold shadow-sm";
            const inactiveClass = "group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60";

            const colors = {
                normal: "border-pink-500 text-pink-600 dark:text-pink-400 hover:border-pink-300",
                sms: "border-emerald-500 text-emerald-600 dark:text-emerald-400 hover:border-emerald-300",
                custom: "border-violet-500 text-violet-600 dark:text-violet-400 hover:border-violet-300"
            };

            ['normal', 'sms', 'custom'].forEach(t => {
                const el = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if(t === mode) {
                    el.className = `${activeClass} ${colors[t]}`;
                } else {
                    el.className = inactiveClass;
                }
            });

            const label = document.getElementById('previewLabel');
            if(mode === 'normal') label.textContent = 'æ—¥ç¨‹èª¿æ•´ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            else if(mode === 'sms') label.textContent = 'äº‹å‰ç¢ºèªSMSãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            else label.textContent = 'AIæ–‡ç« ä½œæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';

            const normalSettings = document.getElementById('normalSettings');
            const customSettings = document.getElementById('customSettings');
            const inspectionCard = document.getElementById('inspectionDetailsCard');
            
            // èƒŒæ™¯è‰²ã®åˆ‡ã‚Šæ›¿ãˆ
            const bodyBg = document.getElementById('bodyBg');
            if(mode === 'sms') {
                bodyBg.className = "bg-gradient-to-br from-emerald-300 via-teal-300 to-cyan-400 dark:from-slate-900 dark:via-emerald-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-emerald-400 selection:text-white bg-animate";
            } else if(mode === 'custom') {
                bodyBg.className = "bg-gradient-to-br from-violet-300 via-fuchsia-300 to-pink-400 dark:from-slate-900 dark:via-violet-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-violet-400 selection:text-white bg-animate";
            } else {
                bodyBg.className = "bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate";
            }

            if (mode === 'custom') {
                normalSettings.classList.add('hidden');
                customSettings.classList.remove('hidden');
                document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-violet-500 to-fuchsia-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
            } else {
                normalSettings.classList.remove('hidden');
                customSettings.classList.add('hidden');
                
                if (mode === 'sms') {
                    inspectionCard.classList.add('hidden');
                    document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                } else {
                    inspectionCard.classList.remove('hidden');
                    document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-pink-500 to-violet-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                }
            }

            updatePreview();
        }

        // Gemini API å‘¼ã³å‡ºã—
        async function handleAIGenerate() {
            const apiKey = localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY;
            if (!apiKey) {
                showToast('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                toggleSettingsModal();
                return;
            }

            const useThinking = document.getElementById('useThinking').checked;
            
            // ãƒ¢ãƒ‡ãƒ«ã¯å¸¸ã«è¨­å®šå€¤ã‚’ä½¿ç”¨
            const model = localStorage.getItem('gemini_model_name') || 'gemini-3-flash-preview';

            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            const content = document.getElementById('customMessage').value.trim();

            if (!customerName || !content) {
                showToast('é¡§å®¢åã¨è¦ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            isGenerating = true;
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiLoading').style.display = 'flex'; // Flexã§è¡¨ç¤º
            
            let prompt = "";

            if (useThinking) {
                // Thinking ON: æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·èª¿
                prompt = `ã‚ãªãŸã¯ä½å®…ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã§ã™ã€‚
æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ç”¨ã„ã¦ã€ãŠå®¢æ§˜ï¼ˆ${customerName} æ§˜ï¼‰ã«å¯¾ã—ã€ä»¥ä¸‹ã®è¦ä»¶ã§ã‚·ãƒ§ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ï¼ˆSMSï¼‰ã®æœ€é©ãªæ–‡é¢ã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚
é€ä¿¡è€…åã¯ã€Œæ¡§å®¶ä½å®… åŸ¼ç‰åŒ—å·¥äº‹éƒ¨ ${staffName}ã€ã§ã™ã€‚

è¦ä»¶ï¼š
${content}

åˆ¶ç´„ï¼š
ãƒ»é¡§å®¢å¯¾å¿œã®ãŸã‚ã€ä¸å¯§ãªè¨€è‘‰é£ã„ã§ã€‚
ãƒ»èª­ã¿ã‚„ã™ããªã‚‹ã‚ˆã†ã€é©åˆ‡ã«æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚
ãƒ»æŒ¨æ‹¶ã‹ã‚‰çµã³ã¾ã§å«ã‚ã‚‹ã€‚
ãƒ»å‡ºåŠ›ã¯ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã®ã¿ã«ã™ã‚‹ï¼ˆã€Œã¯ã„ã€ä½œæˆã—ã¾ã—ãŸã€ç­‰ã®å‰ç½®ãã¯ä¸è¦ï¼‰ã€‚`;
            } else {
                // Thinking OFF: ã‚·ãƒ³ãƒ—ãƒ«ã«æŒ‡ç¤º
                prompt = `ã‚ãªãŸã¯ä½å®…ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã§ã™ã€‚
ãŠå®¢æ§˜ï¼ˆ${customerName} æ§˜ï¼‰ã«å¯¾ã—ã€ä»¥ä¸‹ã®è¦ä»¶ã§ã‚·ãƒ§ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ï¼ˆSMSï¼‰ã®æ–‡é¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
é€ä¿¡è€…åã¯ã€Œæ¡§å®¶ä½å®… åŸ¼ç‰åŒ—å·¥äº‹éƒ¨ ${staffName}ã€ã§ã™ã€‚

è¦ä»¶ï¼š
${content}

åˆ¶ç´„ï¼š
ãƒ»é¡§å®¢å¯¾å¿œã®ãŸã‚ã€ä¸å¯§ãªè¨€è‘‰é£ã„ã§ã€‚
ãƒ»èª­ã¿ã‚„ã™ããªã‚‹ã‚ˆã†ã€é©åˆ‡ã«æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚
ãƒ»æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚„å‰ç½®ãã¯ä¸è¦ã§ã™ã€‚ã™ãã«ä½¿ãˆã‚‹ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ãƒ»æŒ¨æ‹¶ã‹ã‚‰çµã³ã¾ã§å«ã‚ã‚‹ã€‚`;
            }

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`API Error: ${data.error.message || data.error.code}`);
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    document.getElementById('generatedText').value = text.trim();
                    showToast('AIç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                } else {
                    throw new Error('ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™');
                }
            } catch (err) {
                console.error(err);
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nAPIã‚­ãƒ¼ã‚„é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                
                if (err.message.includes('429')) {
                    errorMessage = 'âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹ãŒé›†ä¸­ã—ã¦ãŠã‚Šåˆ¶é™ãŒã‹ã‹ã‚Šã¾ã—ãŸ (429)ã€‚\nã—ã°ã‚‰ãæ™‚é–“ï¼ˆ1åˆ†ç¨‹åº¦ï¼‰ã‚’ç©ºã‘ã¦ã‹ã‚‰å†è©¦è¡Œã™ã‚‹ã‹ã€ã”è‡ªèº«ã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    showToast('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ä¸­: ã—ã°ã‚‰ãå¾…æ©Ÿã—ã¦ãã ã•ã„');
                } else if (err.message.includes('403') || err.message.includes('400')) {
                    errorMessage = `âš ï¸ APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nè¨­å®šç”»é¢ã®ãƒ¢ãƒ‡ãƒ«åãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nè©³ç´°: ${err.message}`;
                    showToast('APIè¨­å®šã‚¨ãƒ©ãƒ¼');
                } else {
                    showToast('ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
                
                document.getElementById('generatedText').value = errorMessage;
            } finally {
                isGenerating = false;
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiLoading').style.display = 'none';
            }
        }

        async function fetchWithRetry(url, options, retries = 3, backoff = 5000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    if (res.status >= 400 && res.status < 500 && res.status !== 429) {
                        throw new Error(`API Error: ${res.status}`);
                    }
                    throw new Error(`API Error: ${res.status}`);
                }
                return res;
            } catch (err) {
                const isRateLimit = err.message.includes('429');
                const isServerError = err.message.match(/5\d\d/);
                const isNetworkError = !err.message.startsWith('API Error'); 

                if (retries > 0 && (isRateLimit || isServerError || isNetworkError)) {
                    console.warn(`Retrying... attempts left: ${retries}, waiting ${backoff}ms`);
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        function updatePreview() {
            if (isGenerating) return;

            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            
            const nameAlert = document.getElementById('nameAlert');
            const alertText = document.getElementById('alertText');
            const copyBtn = document.getElementById('copyBtn');
            
            if (!customerName) {
                nameAlert.classList.remove('hidden');
                nameAlert.style.display = 'flex';
                copyBtn.disabled = true;
                copyBtn.classList.add('grayscale');
            } else if (!staffName) {
                nameAlert.classList.remove('hidden');
                nameAlert.style.display = 'flex';
                copyBtn.disabled = true;
                copyBtn.classList.add('grayscale');
            } else {
                nameAlert.classList.add('hidden');
                nameAlert.style.display = 'none';
                copyBtn.disabled = false;
                copyBtn.classList.remove('grayscale');
            }

            let fullText = "";

            if (currentMode === 'custom') {
                // AIæ–‡ç« ä½œæˆãƒ¢ãƒ¼ãƒ‰: ç”Ÿæˆå‰ã¯ç©ºæ¬„ã€ç”Ÿæˆå¾Œã¯AIã®å‡ºåŠ›ãŒå…¥ã‚‹
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã‹ã€å‰å›ã®çµæœã‚’ç¶­æŒã™ã‚‹
                // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            } else if (currentMode === 'sms') {
                const candidateDates = document.getElementById('candidateDates').value;
                
                fullText = `${customerName} æ§˜\n\n`;
                fullText += `ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚æ¡§å®¶ä½å®…ã®${staffName}ã§ã™ã€‚\n\n`;
                fullText += `æ¬¡å›ã®è¨ªå•æ—¥ç¨‹ã®ç¢ºèªã§ã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\n`;
                fullText += `äºˆå®šé€šã‚Šã€ä¸‹è¨˜æ—¥æ™‚ã«ãŠä¼ºã„ã„ãŸã—ã¾ã™ã€‚\n\n`;
                
                fullText += candidateDates.trim() ? `ã€æ—¥æ™‚ã€‘\n${candidateDates.trim()}\n\n` : `ã€æ—¥æ™‚ã€‘\nï¼ˆæ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰\n\n`;
                
                fullText += `å½“æ—¥ã¯ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n`;
                fullText += `â€»å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ãŠæ—©ã‚ã«ã”é€£çµ¡ãã ã•ã„ã€‚`;

            } else {
                const inspectionTypeSelect = document.getElementById('inspectionType').value;
                const customInspectionType = document.getElementById('customInspectionType').value;
                let type = inspectionTypeSelect === 'ãã®ä»–' ? customInspectionType : inspectionTypeSelect;
                type = type.trim();
                if (type && !type.includes('ç‚¹æ¤œ')) type += 'ç‚¹æ¤œ';

                const issueDetail = document.getElementById('issueDetail').value;
                const needsApology = document.getElementById('needsApology').checked;
                const visitReason = document.querySelector('input[name="visitReason"]:checked').value;
                const candidateDates = document.getElementById('candidateDates').value;

                const greeting = `ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ¡§å®¶ä½å®… åŸ¼ç‰åŒ—å·¥äº‹éƒ¨ã®${staffName}ã§ã™ã€‚`;

                let mainBody = '';
                if (type) mainBody += `å…ˆæ—¥ã¯ã€${type}ã«ãŠç«‹ä¼šã„ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n`;
                if (issueDetail) {
                    mainBody += `ã”æŒ‡æ‘˜ã„ãŸã ãã¾ã—ãŸ${issueDetail}ã®ä»¶ã«ã¤ã„ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\n`;
                }
                
                if (needsApology) {
                    mainBody += issueDetail ? `ç‚¹æ¤œæ—¥ã‹ã‚‰ãŠæ™‚é–“ã‚’ã„ãŸã ã„ã¦ã—ã¾ã„ã€èª ã«ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n` : `ã”é€£çµ¡ãŒé…ããªã‚Šã¾ã—ã¦ã€èª ã«ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n`;
                }

                const reasonText = visitReason === 'ç¾åœ°èª¿æŸ»' ? 'çŠ¶æ³ç¢ºèªï¼ˆç¾åœ°èª¿æŸ»ï¼‰' : 'ä¿®ç¹•ä½œæ¥­';
                let proposal = `ã¤ãã¾ã—ã¦ã¯ã€ä¸‹è¨˜æ—¥ç¨‹ã«ã¦${reasonText}ã«ãŠä¼ºã„ã—ãŸãå­˜ã˜ã¾ã™ã€‚\n\n`;

                if (candidateDates.trim()) {
                    proposal += `ã€å€™è£œæ—¥æ™‚ã€‘\n${candidateDates.trim()}\n\n`;
                    proposal += `ä¸Šè¨˜ä»¥å¤–ã§ã‚‚ã€ç«ãƒ»æ°´ã‚’é™¤ãå¹³æ—¥ãƒ»åœŸæ—¥ã®9æ™‚ï½17æ™‚ã®é–“ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚\nã”éƒ½åˆã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚`;
                } else {
                    proposal += `æã‚Œå…¥ã‚Šã¾ã™ãŒã€ç«ãƒ»æ°´ã‚’é™¤ãå¹³æ—¥ãƒ»åœŸæ—¥ã®9æ™‚ï½17æ™‚ã®é–“ã§ã€\nã”éƒ½åˆã®ã‚ˆã‚ã—ã„æ—¥ç¨‹ã‚’3ã¤ã»ã©ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚`;
                }

                fullText = `${customerName} æ§˜\n\n${greeting}\n\n${mainBody}\n${proposal}\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚\n\næ¡§å®¶ä½å®… åŸ¼ç‰åŒ—å·¥äº‹éƒ¨ ${staffName}`;
            }

            if (currentMode !== 'custom') {
                document.getElementById('generatedText').value = fullText;
            }
        }
        
        // Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
        document.getElementById('customMessage').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.isComposing) {
                if (!e.shiftKey) {
                    e.preventDefault();
                    handleAIGenerate();
                }
            }
        });

        // åˆæœŸå®Ÿè¡Œ
        initTimeOptions();
        loadSettings();
        updatePreview();
    </script>
</body>
</html>
