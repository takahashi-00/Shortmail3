<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„Éï„Çø„ÉºÁÇπÊ§ú„É°„Éº„É´‰ΩúÊàê„ÉÑ„Éº„É´</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'pulse-fast': 'pulseFast 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        },
                        pulseFast: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºË®≠ÂÆö */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆ„É™„É≥„Ç∞Ë™øÊï¥ */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }
        
        /* „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .bg-animate {
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
            transition: background-image 0.5s ease-in-out;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* macOS Window Buttons */
        .mac-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; position: relative; margin-right: 6px; }
        .mac-close { background-color: #FF5F56; border: 0.5px solid #E0443E; }
        .mac-minimize { background-color: #FFBD2E; border: 0.5px solid #DEA123; }
        .mac-maximize { background-color: #27C93F; border: 0.5px solid #1AAB29; }
    </style>
</head>
<body id="bodyBg" class="bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate">

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleSettingsModal()"></div>
        <div class="relative w-full max-w-md bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-6 border border-white/50 dark:border-slate-700 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-black text-slate-700 dark:text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-pink-500"></i>
                    AIË®≠ÂÆö
                </h3>
                <button onclick="toggleSettingsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Gemini API Key</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-[10px] text-pink-500 hover:text-pink-600 hover:underline flex items-center gap-1 transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                            „Ç≠„Éº„ÇíÂèñÂæó„Åô„Çã
                        </a>
                    </div>
                    <input type="password" id="apiKeyInput" placeholder="AIzaSy..." 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">„Ç≠„Éº„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„ÄÅÂ§ñÈÉ®„Å´ÈÄÅ‰ø°„Åï„Çå„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Model Name (Thinking)</label>
                    <input type="text" id="modelNameInput" value="gemini-3-flash-preview"
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">Thinking ONÊôÇ„Å´‰ΩøÁî®„Åô„Çã„É¢„Éá„É´Âêç</p>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-gradient-to-r from-pink-500 to-violet-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-500/30 hover:shadow-pink-500/40 active:scale-95 transition-all">
                    Ë®≠ÂÆö„Çí‰øùÂ≠ò
                </button>
                <button onclick="clearSettings()" class="px-4 py-3.5 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all font-bold text-sm">
                    ÂâäÈô§
                </button>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•Áî®„Éà„Éº„Çπ„Éà -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[110] hidden animate-fade-in">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 border border-white/20 backdrop-blur-md">
            <i data-lucide="info" class="w-4 h-4 text-pink-400"></i>
            <span id="toastText" class="text-sm font-bold">ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏</span>
        </div>
    </div>

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-white/40 dark:border-slate-700/50 sticky top-0 z-50 shadow-sm transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-pink-500 to-violet-500 p-2.5 rounded-2xl text-white shadow-lg shadow-pink-500/30 transform transition-transform hover:scale-110 hover:rotate-3 duration-300">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-violet-600 dark:from-pink-400 dark:to-violet-400 tracking-tight leading-none">After Support Mailer</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold mt-1 tracking-wide">Ê°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ®</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Ë®≠ÂÆö„Éú„Çø„É≥ -->
                <button onclick="toggleSettingsModal()" class="p-2.5 rounded-full text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-white/60 dark:hover:bg-slate-700 transition-all focus:outline-none focus:ring-2 focus:ring-slate-400/50 active:scale-95" title="APIË®≠ÂÆö">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <!-- „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø -->
                <button onclick="toggleDarkMode()" class="p-2.5 rounded-full text-slate-500 hover:text-violet-600 dark:text-slate-400 dark:hover:text-violet-300 hover:bg-white/60 dark:hover:bg-slate-700 transition-all focus:outline-none focus:ring-2 focus:ring-violet-400/50 active:scale-95" title="„ÉÜ„Éº„ÉûÂàáÊõø">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <!-- „É™„Çª„ÉÉ„Éà -->
                <button onclick="resetForm()" class="p-2.5 rounded-full text-slate-500 hover:text-rose-500 hover:bg-rose-50 dark:text-slate-400 dark:hover:bg-rose-900/20 transition-all focus:outline-none focus:ring-2 focus:ring-rose-400/50 active:scale-95" title="„É™„Çª„ÉÉ„Éà">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 lg:py-10 space-y-6">

        <!-- „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Çø„Éñ -->
        <nav class="grid grid-cols-3 gap-2 sm:gap-4">
            <button onclick="setMode('normal')" id="tabNormal" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/70 dark:bg-slate-800/80 border-pink-500 text-pink-600 dark:text-pink-400 font-bold shadow-sm hover:border-pink-300">
                <span class="text-sm">ÈÄöÂ∏∏„É°„Éº„É´</span>
            </button>
            <button onclick="setMode('sms')" id="tabSms" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60">
                <span class="text-sm">‰∫ãÂâçÁ¢∫Ë™çSMS</span>
            </button>
            <button onclick="setMode('custom')" id="tabCustom" class="group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60">
                <div class="flex items-center gap-1.5">
                    <i data-lucide="sparkles" class="w-4 h-4 text-violet-500 group-hover:scale-110 transition-transform"></i>
                    <span class="text-sm">AI„Éó„É≠„É≥„Éó„Éà</span>
                </div>
            </button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Â∑¶„Ç´„É©„É†ÔºöÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- ÂÖ±ÈÄöÔºöÂü∫Êú¨ÊÉÖÂ†±ÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ -->
                <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                    <div class="bg-gradient-to-r from-pink-50/80 to-purple-50/80 dark:from-pink-900/20 dark:to-purple-900/20 px-6 py-4 border-b border-pink-100/50 dark:border-pink-800/30 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center text-pink-500 dark:text-pink-300">
                            <i data-lucide="user-circle" class="w-5 h-5"></i>
                        </div>
                        <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">Âü∫Êú¨ÊÉÖÂ†±Ë®≠ÂÆö</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- È°ßÂÆ¢Âêç -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-pink-500/80 dark:text-pink-400/80 uppercase tracking-wider ml-1">È°ßÂÆ¢Âêç <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="user" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-pink-500 transition-colors"></i>
                                    <input type="text" id="customerName" placeholder="‰æãÔºöÂ±±Áî∞ Â§™ÈÉé" 
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all placeholder:text-slate-400 shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                                </div>
                            </div>

                            <!-- ÊãÖÂΩìËÄÖÂêç -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-purple-500/80 dark:text-purple-400/80 uppercase tracking-wider ml-1">ÊãÖÂΩìËÄÖÂêç <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="briefcase" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-purple-500 transition-colors"></i>
                                    <input type="text" id="staffName" value="Áïë" placeholder="ÊãÖÂΩìËÄÖÂêç"
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „É¢„Éº„ÉâÂà•ÂÖ•Âäõ„Ç®„É™„Ç¢„ÅÆ„Ç≥„É≥„ÉÜ„Éä -->
                <div id="modeSettingsContainer" class="space-y-6 min-h-[400px]">
                    
                    <!-- 1. ÈÄöÂ∏∏„Éª‰∫ãÂâçÁ¢∫Ë™ç„É¢„Éº„ÉâÁî®Ë®≠ÂÆö („Éá„Éï„Ç©„É´„ÉàË°®Á§∫) -->
                    <div id="normalSettings" class="space-y-6 animate-fade-in">
                        
                        <!-- ÁÇπÊ§úË©≥Á¥∞„Ç´„Éº„Éâ (SMS„É¢„Éº„ÉâÊôÇ„ÅØÈùûË°®Á§∫) -->
                        <div id="inspectionDetailsCard" class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-blue-50/80 to-cyan-50/80 dark:from-blue-900/20 dark:to-cyan-900/20 px-6 py-4 border-b border-blue-100/50 dark:border-blue-800/30 flex items-center justify-between">
                                 <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">ÁÇπÊ§ú„Éª‰∏çÂÖ∑ÂêàË©≥Á¥∞</h2>
                                </div>
                                <span class="text-[10px] bg-white/80 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold border border-slate-100 dark:border-slate-600">ÂÆöÂûã„É¢„Éº„Éâ</span>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <!-- ÁÇπÊ§úÁ®ÆÂà• -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-blue-500/80 dark:text-blue-400/80 uppercase tracking-wider ml-1">ÁÇπÊ§úÁ®ÆÂà•</label>
                                    <div class="relative">
                                        <select id="inspectionType" class="w-full px-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white appearance-none cursor-pointer transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            onchange="toggleCustomInspection(); updatePreview()">
                                            <option value="6„ÅãÊúà">6„ÅãÊúàÁÇπÊ§ú</option>
                                            <option value="2Âπ¥">2Âπ¥ÁÇπÊ§ú</option>
                                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñÔºàÊâãÂÖ•ÂäõÔºâ</option>
                                        </select>
                                        <div class="absolute right-3 top-3 pointer-events-none text-slate-400">
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                    <div id="customInspectionWrapper" class="hidden mt-2">
                                        <input type="text" id="customInspectionType" placeholder="‰æãÔºö1Âπ¥ÁÇπÊ§ú„ÄÅËá®ÊôÇÁÇπÊ§ú„Å™„Å©"
                                            class="w-full px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all"
                                            oninput="updatePreview()">
                                    </div>
                                </div>

                                <!-- ‰∏çÂÖ∑ÂêàÂÜÖÂÆπ -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-amber-500/80 dark:text-amber-400/80 uppercase tracking-wider ml-1">‰∏çÂÖ∑Âêà„ÉªÊåáÊëòÂÜÖÂÆπ</label>
                                    <div class="relative group">
                                        <i data-lucide="alert-triangle" class="absolute left-3 top-3 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-amber-500 transition-colors"></i>
                                        <textarea id="issueDetail" placeholder="‰æãÔºö„ÇØ„É≠„Çπ„ÅÆÂâ•„Åå„Çå„ÄÅÂª∫ÂÖ∑„ÅÆË™øÊï¥" rows="3"
                                            class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white resize-none transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            oninput="updatePreview()"></textarea>
                                    </div>
                                </div>

                                <!-- „ÅäË©´„Å≥„Éï„É©„Ç∞ -->
                                <div class="flex items-center justify-between bg-orange-50/60 dark:bg-orange-900/20 p-3 rounded-xl border border-orange-100 dark:border-orange-800/30 transition-colors hover:bg-orange-50 dark:hover:bg-orange-900/30 group cursor-pointer" onclick="document.getElementById('needsApology').click()">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white dark:bg-orange-900/40 p-2 rounded-lg text-orange-500 dark:text-orange-400 shadow-sm">
                                            <i data-lucide="heart-handshake" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-orange-900 dark:text-orange-200">„ÅäË©´„Å≥Êñá„ÇíÊåøÂÖ•</div>
                                            <div class="text-xs text-orange-700/70 dark:text-orange-300/60">ÈÅÖÂª∂ÊôÇ„Å™„Å©„Å´‰ΩøÁî®</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer pointer-events-none">
                                        <input type="checkbox" id="needsApology" class="sr-only peer" onchange="updatePreview()">
                                        <div class="w-10 h-6 bg-slate-300 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:shadow-sm after:transition-all peer-checked:bg-orange-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Ë®™Âïè„ÉªÊó•Á®ãË™øÊï¥„Ç´„Éº„Éâ -->
                        <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-emerald-50/80 to-teal-50/80 dark:from-emerald-900/20 dark:to-teal-900/20 px-6 py-4 border-b border-emerald-100/50 dark:border-emerald-800/30 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center text-emerald-500 dark:text-emerald-300">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                </div>
                                <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">Ë®™Âïè„ÉªÊó•Á®ãË™øÊï¥</h2>
                            </div>

                            <div class="p-6 space-y-6">
                                <!-- Ë®™ÂïèÁêÜÁî± -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">Ë®™ÂïèÁêÜÁî±</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="‰øÆÁπï‰ΩúÊ•≠" checked class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-blue-50/90 dark:peer-checked:bg-blue-900/40 peer-checked:border-blue-500 dark:peer-checked:border-blue-400 peer-checked:text-blue-600 dark:peer-checked:text-blue-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="wrench" class="w-4 h-4"></i> ‰øÆÁπï‰ΩúÊ•≠
                                            </div>
                                        </label>
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="ÁèæÂú∞Ë™øÊüª" class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-emerald-50/90 dark:peer-checked:bg-emerald-900/40 peer-checked:border-emerald-500 dark:peer-checked:border-emerald-400 peer-checked:text-emerald-600 dark:peer-checked:text-emerald-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="search" class="w-4 h-4"></i> ÁèæÂú∞Ë™øÊüª
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- ÂÄôË£úÊó•ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-end mb-1">
                                        <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">Êó•ÊôÇË®≠ÂÆö</label>
                                        <button onclick="clearCandidates()" id="clearBtn" class="hidden text-xs text-rose-400 hover:text-rose-600 flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-rose-50 dark:hover:bg-rose-900/20 font-bold">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> „ÇØ„É™„Ç¢
                                        </button>
                                    </div>
                                    
                                    <!-- „Ç´„É¨„É≥„ÉÄ„Éº„ÉÑ„Éº„É´Ôºà15ÂàÜÂàª„ÅøÔºãÁµÇ‰∫ÜÊôÇÈñì„Ç™„Éó„Ç∑„Éß„É≥Ôºâ -->
                                    <div class="flex flex-wrap items-end gap-2 mb-3 p-3 bg-white/50 dark:bg-slate-700/30 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm">
                                        <div class="flex-1 min-w-[130px]">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">Êó•‰ªò</label>
                                            <input type="date" id="dateInput" class="w-full px-3 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white transition-all focus:ring-2 focus:ring-emerald-500/50">
                                        </div>
                                        
                                        <div class="w-full sm:w-auto">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">ÊôÇÈñì</label>
                                            <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                                                <div class="relative min-w-[90px]">
                                                    <select id="timeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                        <!-- JS„ÅßÁîüÊàê -->
                                                    </select>
                                                    <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                </div>

                                                <!-- ÁµÇ‰∫ÜÊôÇÈñì„Ç®„É™„Ç¢ -->
                                                <div class="flex items-center gap-2" id="endTimeArea">
                                                    <span class="text-slate-400 text-sm hidden" id="tilde">ÔΩû</span>
                                                    <div class="relative min-w-[90px] hidden" id="endTimeWrapper">
                                                        <select id="endTimeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                            <!-- JS„ÅßÁîüÊàê -->
                                                        </select>
                                                        <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                    </div>
                                                    
                                                    <label class="cursor-pointer select-none">
                                                        <input type="checkbox" id="useEndTime" class="sr-only peer" onchange="toggleEndTime()">
                                                        <span class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-1.5 rounded hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors peer-checked:hidden flex items-center gap-1">
                                                            <i data-lucide="clock" class="w-3 h-3"></i> ÁµÇ‰∫ÜÊôÇÈñì
                                                        </span>
                                                        <span class="hidden peer-checked:flex text-slate-400 hover:text-slate-600 cursor-pointer p-1">
                                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <button onclick="addCandidateDate()" id="addBtn" disabled class="h-[38px] px-3 bg-slate-800 dark:bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 dark:hover:bg-emerald-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 shadow-md active:scale-95 ml-auto sm:ml-0">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>

                                    <textarea id="candidateDates" rows="4" placeholder="ÂÄôË£úÊó•„ÄÅ„Åæ„Åü„ÅØÁ¢∫ÂÆöÊó•ÊôÇ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                        class="w-full p-4 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-700 dark:text-white font-mono text-sm shadow-sm transition-all placeholder:text-slate-400 focus:bg-white dark:focus:bg-slate-800"
                                        oninput="updatePreview(); toggleClearBtn()"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. AI„Éó„É≠„É≥„Éó„ÉàÁîüÊàê„É¢„Éº„ÉâÁî®Ë®≠ÂÆö -->
                    <div id="customSettings" class="hidden space-y-6 animate-fade-in">
                        <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-violet-50/80 to-fuchsia-50/80 dark:from-violet-900/20 dark:to-fuchsia-900/20 px-6 py-4 border-b border-violet-100/50 dark:border-violet-800/30 flex items-center justify-between">
                                 <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-500 dark:text-violet-300">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">AI„Éó„É≠„É≥„Éó„ÉàÁîüÊàê</h2>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <!-- Thinking Toggle -->
                                    <label class="flex items-center gap-2 cursor-pointer bg-white/40 dark:bg-black/20 px-3 py-1.5 rounded-full border border-white/20 hover:bg-white/60 dark:hover:bg-black/40 transition-all select-none" title="ÊÄùËÄÉ„Éó„É≠„Çª„Çπ(Thinking)„ÇíÊúâÂäπ„Å´„Åô„Çã">
                                        <i data-lucide="brain-circuit" class="w-3.5 h-3.5 text-slate-500 dark:text-slate-300"></i>
                                        <span class="text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Thinking</span>
                                        <div class="relative">
                                            <input type="checkbox" id="useThinking" class="sr-only peer" checked>
                                            <div class="w-7 h-4 bg-slate-400/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-violet-500"></div>
                                        </div>
                                    </label>

                                    <button id="aiGenerateBtn" onclick="handleAIGenerate()" class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white text-xs font-bold rounded-full shadow-lg hover:shadow-violet-500/30 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-50 disabled:grayscale">
                                        <i data-lucide="zap" class="w-3 h-3"></i>
                                        AI„ÅßÁîüÊàê„Åô„Çã
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <div class="bg-violet-50/60 dark:bg-violet-900/10 p-4 rounded-2xl text-sm text-slate-600 dark:text-slate-300 leading-relaxed border border-violet-100 dark:border-violet-800/30">
                                    <span class="font-bold text-violet-600 dark:text-violet-400 block mb-1">üí° „Éí„É≥„Éà</span>
                                    Âè≥‰∏ä„ÅÆË®≠ÂÆö„Ç¢„Ç§„Ç≥„É≥„Åã„ÇâAPI„Ç≠„Éº„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅ„Åì„Åì„ÅßAI„Å´Áõ¥Êé•ÊñáÁ´†„Çí‰ΩúÊàê„Åï„Åõ„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ<br>
                                    ÁôªÈå≤„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ‰∏ã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Å¶‰ªñ„ÅÆAI„ÉÑ„Éº„É´„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </div>

                                <!-- Ëá™Áî±ÂÖ•ÂäõÁî®‰ª∂ -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-violet-500/80 dark:text-violet-400/80 uppercase tracking-wider ml-1">‰ºù„Åà„Åü„ÅÑË¶Å‰ª∂Ôºà„É°„É¢Êõ∏„Åç„ÅßOKÔºâ <span class="text-rose-500">*</span></label>
                                    <div class="relative group">
                                        <textarea id="customMessage" placeholder="‰æãÔºö&#13;&#10;„ÉªÊù•ÈÄ±„ÅÆÊúàÊõúÊó•„Å´ÈõªË©±„Åó„Åü„ÅÑ&#13;&#10;„ÉªÊôÇÈñì„ÅØ10ÊôÇ„Åã„Çâ12ÊôÇ„ÅÆÈñì„Åå„ÅÑ„ÅÑ&#13;&#10;„ÉªÈÉΩÂêà„ÅåÊÇ™„Åë„Çå„Å∞Êïô„Åà„Å¶„Åª„Åó„ÅÑ" rows="8"
                                            class="w-full p-4 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white resize-none transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm leading-relaxed"
                                            oninput="updatePreview()"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Âè≥„Ç´„É©„É†Ôºö„Éó„É¨„Éì„É•„Éº -->
            <div class="lg:col-span-5 space-y-6 lg:sticky lg:top-[5.5rem] self-start">
                
                <!-- ‰∏äÁ´ØÊèÉ„Åà„ÅÆ„Åü„ÇÅ„Å´„Çø„Ç§„Éà„É´Ë°å„ÇíÂâäÈô§„Åó„ÄÅ„Éó„É¨„Éì„É•„Éº„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÁõ¥ÈÖçÁΩÆ„Åô„ÇãÊßãÊàê„Å´Â§âÊõ¥ -->
                
                <div class="relative group h-[calc(100vh-140px)] min-h-[500px]">
                    <!-- ËÉåÊôØ„ÅÆË£ÖÈ£æÔºà„Ç∞„É≠„ÉºÂäπÊûúÔºâ -->
                    <div id="previewGlow" class="absolute -inset-1 bg-gradient-to-br from-pink-500 to-violet-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000"></div>
                    
                    <div class="relative bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/60 dark:border-slate-600/50 overflow-hidden transition-colors duration-300 flex flex-col h-full">
                        
                        <!-- MacÈ¢®„Éó„É¨„Éì„É•„Éº„Éò„ÉÉ„ÉÄ„ÉºÔºà„Åì„Åì„Å´„Çø„Ç§„Éà„É´„Å®„Ç¢„É©„Éº„Éà„ÇíÁµ±ÂêàÔºâ -->
                        <div class="bg-gray-100/80 dark:bg-slate-800/80 border-b border-gray-200 dark:border-slate-700 px-4 py-3 flex items-center justify-between h-12 flex-shrink-0">
                            <div class="flex gap-2 opacity-100 group/btns w-20">
                                <div class="mac-dot mac-close shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-minimize shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-maximize shadow-sm hover:brightness-90 transition-all"></div>
                            </div>
                            
                            <span id="previewLabel" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest select-none truncate">
                                ÈÄöÂ∏∏„É°„Éº„É´„Éó„É¨„Éì„É•„Éº
                            </span>

                            <div class="w-20 flex justify-end">
                                <!-- „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç¢„É©„Éº„Éà„Çí„Åì„Åì„Å´ÈÖçÁΩÆ -->
                                <div id="nameAlert" class="hidden flex items-center gap-1 text-[10px] font-bold text-rose-500 animate-pulse">
                                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                                    <span>ÂÖ•ÂäõÂøÖÈ†à</span>
                                </div>
                            </div>
                        </div>

                        <!-- „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ (Á∑®ÈõÜÂèØËÉΩ„Å´Â§âÊõ¥) -->
                        <div class="flex-1 relative overflow-hidden">
                            <textarea id="generatedText"
                                class="w-full h-full p-6 bg-transparent resize-none font-mono text-sm leading-relaxed focus:outline-none text-slate-700 dark:text-slate-300 selection:bg-pink-100 dark:selection:bg-pink-900/30 overflow-y-auto"></textarea>
                            
                            <!-- AIÁîüÊàê‰∏≠„É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
                            <div id="aiLoading" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4 hidden z-20">
                                <div class="w-10 h-10 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin"></div>
                                <span class="text-xs font-bold text-violet-600 dark:text-violet-400 animate-pulse">AIÊÄùËÄÉ‰∏≠...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- „Ç≥„Éî„Éº„Éú„Çø„É≥ -->
                    <div class="absolute bottom-6 right-6 z-10">
                        <button onclick="handleCopy()" id="copyBtn" disabled
                            class="flex items-center gap-2 px-6 py-3.5 rounded-full font-bold shadow-lg shadow-pink-500/30 transition-all transform hover:-translate-y-1 active:scale-95 bg-gradient-to-r from-pink-500 to-violet-600 text-white hover:shadow-xl hover:shadow-pink-500/40 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none grayscale disabled:grayscale ring-4 ring-white/30 dark:ring-black/30 backdrop-blur-sm">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="tracking-wide" id="copyBtnText">COPY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let currentMode = 'normal';
        let isGenerating = false;

        // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        const loadSettings = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            const savedModel = localStorage.getItem('gemini_model_name');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
            if (savedModel) document.getElementById('modelNameInput').value = savedModel;
            
            // AI„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            updateAIBtnState();
        };

        const updateAIBtnState = () => {
            const btn = document.getElementById('aiGenerateBtn');
            const hasKey = !!localStorage.getItem('gemini_api_key');
            if(btn) {
                btn.disabled = !hasKey;
                btn.title = hasKey ? "AI„ÅßÁîüÊàê" : "API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            }
        };

        // Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò
        const saveSettings = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelNameInput').value.trim();
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model_name', model);
            showToast('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            toggleSettingsModal();
            updateAIBtnState();
            updatePreview();
        };

        const clearSettings = () => {
            if(!confirm('Ë®≠ÂÆö„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('gemini_model_name');
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('modelNameInput').value = 'gemini-3-flash-preview';
            showToast('Ë®≠ÂÆö„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            updateAIBtnState();
        };

        const toggleSettingsModal = () => {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
        };

        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            document.getElementById('toastText').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        // ÊôÇÈñì„Ç™„Éó„Ç∑„Éß„É≥ÁîüÊàê
        const initTimeOptions = () => {
            const timeSelect = document.getElementById('timeInput');
            const endTimeSelect = document.getElementById('endTimeInput');
            let options = '';
            
            // 9:00 - 19:00, 15ÂàÜÂàª„Åø
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break; // 19:00„Åæ„Åß
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    // „Éá„Éï„Ç©„É´„Éà10:00
                    const isSelected = time === '10:00' ? 'selected' : '';
                    options += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            timeSelect.innerHTML = options;
            
            // ÁµÇ‰∫ÜÊôÇÈñìÁî® (15:00„Éá„Éï„Ç©„É´„Éà)
            let endOptions = '';
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break;
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const isSelected = time === '15:00' ? 'selected' : '';
                    endOptions += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            endTimeSelect.innerHTML = endOptions;
        };

        const toggleEndTime = () => {
            const isChecked = document.getElementById('useEndTime').checked;
            const wrapper = document.getElementById('endTimeWrapper');
            const tilde = document.getElementById('tilde');
            
            if (isChecked) {
                wrapper.classList.remove('hidden');
                tilde.classList.remove('hidden');
            } else {
                wrapper.classList.add('hidden');
                tilde.classList.add('hidden');
            }
        };

        // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàùÊúüÂåñ („Éá„Éï„Ç©„É´„Éà„ÅØ„É©„Ç§„Éà)
        if (localStorage.theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        // „É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
        function resetForm() {
            if (!confirm('ÂÖ•ÂäõÂÜÖÂÆπ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;

            document.getElementById('customerName').value = '';
            document.getElementById('staffName').value = 'Áïë'; 
            document.getElementById('inspectionType').value = '6„ÅãÊúà';
            document.getElementById('customInspectionType').value = '';
            document.getElementById('issueDetail').value = '';
            document.getElementById('needsApology').checked = false;
            
            const visitRadios = document.getElementsByName('visitReason');
            for(const r of visitRadios) {
                if(r.value === '‰øÆÁπï‰ΩúÊ•≠') r.checked = true;
            }

            document.getElementById('dateInput').value = '';
            // ÊôÇÂàª„É™„Çª„ÉÉ„Éà
            document.getElementById('timeInput').value = '10:00';
            document.getElementById('endTimeInput').value = '15:00';
            document.getElementById('useEndTime').checked = false;
            toggleEndTime();

            document.getElementById('candidateDates').value = '';
            document.getElementById('customMessage').value = '';

            document.getElementById('customInspectionWrapper').classList.add('hidden');
            toggleClearBtn();
            setMode('normal');
            updatePreview();
        }

        // „É¢„Éº„ÉâÂàáÊõø
        function setMode(mode) {
            currentMode = mode;
            
            const activeClass = "group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/70 dark:bg-slate-800/80 font-bold shadow-sm";
            const inactiveClass = "group relative flex flex-col items-center justify-center py-4 rounded-xl border-2 transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60";

            const colors = {
                normal: "border-pink-500 text-pink-600 dark:text-pink-400 hover:border-pink-300",
                sms: "border-emerald-500 text-emerald-600 dark:text-emerald-400 hover:border-emerald-300",
                custom: "border-violet-500 text-violet-600 dark:text-violet-400 hover:border-violet-300"
            };

            ['normal', 'sms', 'custom'].forEach(t => {
                const el = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if(t === mode) {
                    el.className = `${activeClass} ${colors[t]}`;
                } else {
                    el.className = inactiveClass;
                }
            });

            const label = document.getElementById('previewLabel');
            if(mode === 'normal') label.textContent = 'ÈÄöÂ∏∏„É°„Éº„É´„Éó„É¨„Éì„É•„Éº';
            else if(mode === 'sms') label.textContent = '‰∫ãÂâçÁ¢∫Ë™çSMS„Éó„É¨„Éì„É•„Éº';
            else label.textContent = 'AI„Éó„É≠„É≥„Éó„Éà„Éó„É¨„Éì„É•„Éº';

            const normalSettings = document.getElementById('normalSettings');
            const customSettings = document.getElementById('customSettings');
            const inspectionCard = document.getElementById('inspectionDetailsCard');
            
            // ËÉåÊôØËâ≤„ÅÆÂàá„ÇäÊõø„Åà
            const bodyBg = document.getElementById('bodyBg');
            if(mode === 'sms') {
                bodyBg.className = "bg-gradient-to-br from-emerald-300 via-teal-300 to-cyan-400 dark:from-slate-900 dark:via-emerald-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-emerald-400 selection:text-white bg-animate";
            } else if(mode === 'custom') {
                bodyBg.className = "bg-gradient-to-br from-violet-300 via-fuchsia-300 to-pink-400 dark:from-slate-900 dark:via-violet-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-violet-400 selection:text-white bg-animate";
            } else {
                bodyBg.className = "bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate";
            }

            if (mode === 'custom') {
                normalSettings.classList.add('hidden');
                customSettings.classList.remove('hidden');
                document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-violet-500 to-fuchsia-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
            } else {
                normalSettings.classList.remove('hidden');
                customSettings.classList.add('hidden');
                
                if (mode === 'sms') {
                    inspectionCard.classList.add('hidden');
                    document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                } else {
                    inspectionCard.classList.remove('hidden');
                    document.getElementById('previewGlow').className = "absolute -inset-1 bg-gradient-to-br from-pink-500 to-violet-600 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                }
            }

            updatePreview();
        }

        // Gemini API Âëº„Å≥Âá∫„Åó
        async function handleAIGenerate() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                showToast('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                toggleSettingsModal();
                return;
            }

            const useThinking = document.getElementById('useThinking').checked;
            
            // Thinking ON„Å™„ÇâË®≠ÂÆöÂÄ§(„Éá„Éï„Ç©„É´„Éà: gemini-3-flash-preview)„ÄÅOFF„Å™„ÇâÈÄöÂ∏∏Flash„É¢„Éá„É´
            let model = localStorage.getItem('gemini_model_name') || 'gemini-3-flash-preview';
            if (!useThinking) {
                model = 'gemini-2.0-flash-exp'; // È´òÈÄü„É¢„Éá„É´
            }

            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            const content = document.getElementById('customMessage').value.trim();

            if (!customerName || !content) {
                showToast('È°ßÂÆ¢Âêç„Å®Ë¶Å‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            isGenerating = true;
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiLoading').style.display = 'flex'; // Flex„ÅßË°®Á§∫
            
            const prompt = `„ÅÇ„Å™„Åü„ÅØ‰ΩèÂÆÖ„É°„Éº„Ç´„Éº„ÅÆ„Ç¢„Éï„Çø„Éº„Çµ„Éù„Éº„ÉàÊãÖÂΩìËÄÖ„Åß„Åô„ÄÇ
„ÅäÂÆ¢ÊßòÔºà${customerName} ÊßòÔºâ„Å´ÂØæ„Åó„ÄÅ‰ª•‰∏ã„ÅÆË¶Å‰ª∂„Åß„Ç∑„Éß„Éº„Éà„É°„Éº„É´ÔºàSMSÔºâ„ÅÆÊñáÈù¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈÄÅ‰ø°ËÄÖÂêç„ÅØ„ÄåÊ°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ® ${staffName}„Äç„Åß„Åô„ÄÇ

Ë¶Å‰ª∂Ôºö
${content}

Âà∂Á¥ÑÔºö
„ÉªÈ°ßÂÆ¢ÂØæÂøú„ÅÆ„Åü„ÇÅ„ÄÅ‰∏ÅÂØß„Å™Ë®ÄËëâÈÅ£„ÅÑ„Åß„ÄÇ
„ÉªË™≠„Åø„ÇÑ„Åô„Åè„Å™„Çã„Çà„ÅÜ„ÄÅÈÅ©Âàá„Å´ÊîπË°å„ÇíÂÖ•„Çå„Çã„Åì„Å®„ÄÇ
„ÉªÊå®Êã∂„Åã„ÇâÁµê„Å≥„Åæ„ÅßÂê´„ÇÅ„Çã„ÄÇ
„ÉªÂá∫Âäõ„ÅØ„É°„Éº„É´Êú¨Êñá„ÅÆ„Åø„Å´„Åô„ÇãÔºà„Äå„ÅØ„ÅÑ„ÄÅ‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄçÁ≠â„ÅÆÂâçÁΩÆ„Åç„ÅØ‰∏çË¶ÅÔºâ„ÄÇ`;

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    document.getElementById('generatedText').value = text.trim();
                    showToast('AIÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                } else {
                    throw new Error('ÁîüÊàê„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„ÅåÁ©∫„Åß„Åô');
                }
            } catch (err) {
                console.error(err);
                showToast('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message);
                document.getElementById('generatedText').value = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\nAPI„Ç≠„Éº„ÇÑÈÄö‰ø°Áä∂Ê≥Å„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } finally {
                isGenerating = false;
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiLoading').style.display = 'none';
            }
        }

        async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                return res;
            } catch (err) {
                if (retries === 0) throw err;
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }

        function updatePreview() {
            if (isGenerating) return;

            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            
            const nameAlert = document.getElementById('nameAlert');
            const alertText = document.getElementById('alertText');
            const copyBtn = document.getElementById('copyBtn');
            
            if (!customerName) {
                // alertText.textContent = "È°ßÂÆ¢Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                nameAlert.classList.remove('hidden');
                nameAlert.style.display = 'flex';
                copyBtn.disabled = true;
                copyBtn.classList.add('grayscale');
            } else if (!staffName) {
                // alertText.textContent = "ÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                nameAlert.classList.remove('hidden');
                nameAlert.style.display = 'flex';
                copyBtn.disabled = true;
                copyBtn.classList.add('grayscale');
            } else {
                nameAlert.classList.add('hidden');
                nameAlert.style.display = 'none';
                copyBtn.disabled = false;
                copyBtn.classList.remove('grayscale');
            }

            // ÊâãÂãïÂÖ•Âäõ‰∏≠„Åß„ÅÇ„Çå„Å∞‰∏äÊõ∏„Åç„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºà„Åü„Å†„Åó„É¢„Éº„ÉâÂàáÊõøÊôÇ„ÇÑÂøÖÈ†àÈ†ÖÁõÆÂ§âÊõ¥ÊôÇ„ÅØÊõ¥Êñ∞„Åó„Åü„ÅÑÔºâ
            // Á∞°ÊòìÁöÑ„Å´„ÄÅAIÁîüÊàê„É¢„Éº„Éâ„Åã„Å§API„Ç≠„Éº„ÅÇ„Çä„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÊõ¥Êñ∞„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Âæ°„Åô„ÇãÔºü
            // „ÅÑ„ÇÑ„ÄÅ„É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÅØ„Äå‰ªªÊÑè„Å´Á∑®ÈõÜ„Åß„Åç„Çã„Äç„Åì„Å®„ÄÇ
            // Á∑®ÈõÜ„Åï„Çå„ÅüÂÜÖÂÆπ„ÅØ‰øùÊåÅ„Åó„Åü„ÅÑ„Åå„ÄÅÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅåÂ§â„Çè„Å£„Åü„ÇâÂÜçÁîüÊàê„Åï„Çå„Çã„ÅÆ„ÅåÂü∫Êú¨„É≠„Ç∏„ÉÉ„ÇØ„ÄÇ
            // „Åì„Åì„Åß„ÅØ„ÄåÁ∑®ÈõÜÂèØËÉΩ„Å´„Åô„Çã„ÄçÂØæÂøú„Å®„Åó„Å¶ readonly „ÇíÂ§ñ„Åô„ÅÆ„Åø„Å®„Åô„Çã„ÄÇ
            
            let fullText = "";

            // Êó¢„Å´„É¶„Éº„Ç∂„Éº„ÅåÊâãÂãïÁ∑®ÈõÜ„Åó„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÄÅ„Åù„Çå„ÇíÁ∂≠ÊåÅ„Åô„Çã„ÅãÔºü
            // ‰ªäÂõû„ÅØ„Ç∑„É≥„Éó„É´„Å´„ÄÅ„Éï„Ç©„Éº„É†ÂÖ•Âäõ„ÅåÂ§â„Çè„Çå„Å∞„Éó„É¨„Éì„É•„Éº„ÇÇÊõ¥Êñ∞„Åï„Çå„Çã‰ªïÊßò„Å®„Åô„Çã„ÄÇ
            // „Åü„Å†„ÅóAIÁîüÊàêÂÆå‰∫ÜÂæå„ÅØ updatePreview „ÅåËµ∞„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´ isGenerating „Éï„É©„Ç∞„ÅØ„ÅÇ„Çã„ÄÇ
            
            if (currentMode === 'custom') {
                const message = document.getElementById('customMessage').value;
                const content = message ? message : 'Ôºà„Åì„Åì„Å´AI„Å´‰ºù„Åà„Åü„ÅÑË¶Å‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ';
                const hasKey = !!localStorage.getItem('gemini_api_key');
                
                if (hasKey) {
                    // API„Ç≠„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éú„Çø„É≥„ÇíÊäº„Åô„Åæ„Åß„Éó„É¨„Éì„É•„Éº„ÅØÁ©∫Ôºà„ÇÇ„Åó„Åè„ÅØÂâçÂõû„ÅÆÁµêÊûúÔºâ„Åß„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅ
                    // „Åì„Åì„Åß„ÅØ„Éó„É≠„É≥„Éó„Éà„ÅÆÊßãÊàê„ÇíË°®Á§∫„Åó„Å¶„Åä„ÅèÔºàÁîüÊàêÂâçÔºâ
                    // „ÇÇ„Åó„Åè„ÅØ„ÄÅ„ÄåÁîüÊàê„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç„Å®Âá∫„Åô„Åã„ÄÇ
                    // Êó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁ∂≠ÊåÅ„Åó„Å§„Å§„ÄÅ„Éó„É≠„É≥„Éó„ÉàÊ°à„ÇíÂá∫„Åô„ÄÇ
                    fullText = "ÔºàÂè≥‰∏ä„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®AI„ÅåÊñáÁ´†„ÇíÁîüÊàê„Åó„Åæ„ÅôÔºâ\n\n" + 
                               "ÊâãÂãï„Éó„É≠„É≥„Éó„Éà‰ΩúÊàêÁî®:\n" +
                               `# ÂëΩ‰ª§\n„ÅÇ„Å™„Åü„ÅØ‰ΩèÂÆÖ„É°„Éº„Ç´„Éº„ÅÆÊãÖÂΩìËÄÖ„Åß„Åô„ÄÇ\n„ÅäÂÆ¢Êßò„Å´ÈÄÅ„Çã„Ç∑„Éß„Éº„Éà„É°„Éº„É´ÔºàSMSÔºâ„ÅÆÊñáÈù¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n# ÂÖ•ÂäõÊÉÖÂ†±\n„ÉªÂÆõÂêç: ${customerName} Êßò\n„ÉªÂ∑ÆÂá∫‰∫∫: Ê°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ® ${staffName}\n„ÉªË¶Å‰ª∂: ${content}\n\n# Âá∫Âäõ\n‰∏ÅÂØß„ÅßË¶™„Åó„Åø„ÇÑ„Åô„ÅÑÊñáÈù¢Ê°à„Çí1„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                } else {
                    fullText = `# ÂëΩ‰ª§
„ÅÇ„Å™„Åü„ÅØ‰ΩèÂÆÖ„É°„Éº„Ç´„Éº„ÅÆ„Ç¢„Éï„Çø„Éº„Çµ„Éù„Éº„ÉàÊãÖÂΩìËÄÖ„Åß„Åô„ÄÇ
„ÅäÂÆ¢Êßò„Å´ÈÄÅ„ÇãÊê∫Â∏ØÈõªË©±„ÅÆ„Ç∑„Éß„Éº„Éà„É°„Éº„É´ÔºàSMS/MMSÔºâ„ÅÆÊñáÈù¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

# Âà∂Á¥Ñ
„ÉªÈ°ßÂÆ¢ÂØæÂøú„ÅÆ„Åü„ÇÅ„ÄÅ‰∏ÅÂØß„Å™Ë®ÄËëâÈÅ£„ÅÑ„Åß„ÄÇ
„ÉªË™≠„Åø„ÇÑ„Åô„Åè„Å™„Çã„Çà„ÅÜ„ÄÅÈÅ©Âàá„Å´ÊîπË°å„ÇíÂÖ•„Çå„Çã„Åì„Å®„ÄÇ

# ÂÖ•ÂäõÊÉÖÂ†±
„ÉªÂÆõÂêç: ${customerName} Êßò
„ÉªÂ∑ÆÂá∫‰∫∫: Ê°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ® ${staffName}
„ÉªË¶Å‰ª∂/‰ºù„Åà„Åü„ÅÑ„Åì„Å®:
${content}

# Âá∫Âäõ
‰∏ÅÂØß„ÅßË¶™„Åó„Åø„ÇÑ„Åô„ÅÑÊñáÈù¢Ê°à„Çí1„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Ç≥„Éî„Éº„Åó„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´„ÄÅ‰ΩúÊàê„Åó„ÅüÊú¨Êñá„ÅØ„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØÔºà\`\`\`text ... \`\`\`Ôºâ„ÅßÂõ≤„Çì„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                }

            } else if (currentMode === 'sms') {
                const candidateDates = document.getElementById('candidateDates').value;
                
                fullText = `${customerName} Êßò\n\n`;
                fullText += `„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇÊ°ßÂÆ∂‰ΩèÂÆÖ„ÅÆ${staffName}„Åß„Åô„ÄÇ\n\n`;
                fullText += `Ê¨°Âõû„ÅÆË®™ÂïèÊó•Á®ã„ÅÆÁ¢∫Ë™ç„Åß„ÅîÈÄ£Áµ°„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\n`;
                fullText += `‰∫àÂÆöÈÄö„Çä„ÄÅ‰∏ãË®òÊó•ÊôÇ„Å´„Åä‰º∫„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n\n`;
                
                fullText += candidateDates.trim() ? `„ÄêÊó•ÊôÇ„Äë\n${candidateDates.trim()}\n\n` : `„ÄêÊó•ÊôÇ„Äë\nÔºàÊó•ÊôÇ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ\n\n`;
                
                fullText += `ÂΩìÊó•„ÅØ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n`;
                fullText += `‚ÄªÂ§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÅäÊó©„ÇÅ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ`;

            } else {
                const inspectionTypeSelect = document.getElementById('inspectionType').value;
                const customInspectionType = document.getElementById('customInspectionType').value;
                let type = inspectionTypeSelect === '„Åù„ÅÆ‰ªñ' ? customInspectionType : inspectionTypeSelect;
                type = type.trim();
                if (type && !type.includes('ÁÇπÊ§ú')) type += 'ÁÇπÊ§ú';

                const issueDetail = document.getElementById('issueDetail').value;
                const needsApology = document.getElementById('needsApology').checked;
                const visitReason = document.querySelector('input[name="visitReason"]:checked').value;
                const candidateDates = document.getElementById('candidateDates').value;

                const greeting = `„ÅÑ„Å§„ÇÇÂ§ßÂ§â„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ\nÊ°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ®„ÅÆ${staffName}„Åß„Åô„ÄÇ`;

                let mainBody = '';
                if (type) mainBody += `ÂÖàÊó•„ÅØ„ÄÅ${type}„Å´„ÅäÁ´ã‰ºö„ÅÑ„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ\n`;
                if (issueDetail) {
                    mainBody += `„ÅîÊåáÊëò„ÅÑ„Åü„Å†„Åç„Åæ„Åó„Åü${issueDetail}„ÅÆ‰ª∂„Å´„Å§„ÅÑ„Å¶„ÅîÈÄ£Áµ°„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\n`;
                }
                
                if (needsApology) {
                    mainBody += issueDetail ? `ÁÇπÊ§úÊó•„Åã„Çâ„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„ÅÑ„Å¶„Åó„Åæ„ÅÑ„ÄÅË™†„Å´Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n` : `„ÅîÈÄ£Áµ°„ÅåÈÅÖ„Åè„Å™„Çä„Åæ„Åó„Å¶„ÄÅË™†„Å´Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n`;
                }

                const reasonText = visitReason === 'ÁèæÂú∞Ë™øÊüª' ? 'Áä∂Ê≥ÅÁ¢∫Ë™çÔºàÁèæÂú∞Ë™øÊüªÔºâ' : '‰øÆÁπï‰ΩúÊ•≠';
                let proposal = `„Å§„Åç„Åæ„Åó„Å¶„ÅØ„ÄÅ‰∏ãË®òÊó•Á®ã„Å´„Å¶${reasonText}„Å´„Åä‰º∫„ÅÑ„Åó„Åü„ÅèÂ≠ò„Åò„Åæ„Åô„ÄÇ\n\n`;

                if (candidateDates.trim()) {
                    proposal += `„ÄêÂÄôË£úÊó•ÊôÇ„Äë\n${candidateDates.trim()}\n\n`;
                    proposal += `‰∏äË®ò‰ª•Â§ñ„Åß„ÇÇ„ÄÅÁÅ´„ÉªÊ∞¥„ÇíÈô§„ÅèÂπ≥Êó•„ÉªÂúüÊó•„ÅÆ9ÊôÇÔΩû17ÊôÇ„ÅÆÈñì„ÅßË™øÊï¥ÂèØËÉΩ„Åß„Åô„ÄÇ\n„ÅîÈÉΩÂêà„ÅØ„ÅÑ„Åã„Åå„Åß„Åó„Çá„ÅÜ„Åã„ÄÇ`;
                } else {
                    proposal += `ÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÄÅÁÅ´„ÉªÊ∞¥„ÇíÈô§„ÅèÂπ≥Êó•„ÉªÂúüÊó•„ÅÆ9ÊôÇÔΩû17ÊôÇ„ÅÆÈñì„Åß„ÄÅ\n„ÅîÈÉΩÂêà„ÅÆ„Çà„Çç„Åó„ÅÑÊó•Á®ã„Çí3„Å§„Åª„Å©„ÅäÁü•„Çâ„Åõ„ÅÑ„Åü„Å†„Åë„Åæ„Åô„Åß„Åó„Çá„ÅÜ„Åã„ÄÇ`;
                }

                fullText = `${customerName} Êßò\n\n${greeting}\n\n${mainBody}\n${proposal}\n\n‰ΩïÂçí„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑÁî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ\n\nÊ°ßÂÆ∂‰ΩèÂÆÖ ÂüºÁéâÂåóÂ∑•‰∫ãÈÉ® ${staffName}`;
            }

            // „É¶„Éº„Ç∂„Éº„ÅåÊâãÂãïÁ∑®ÈõÜ„Åó„Å¶„ÅÑ„Å™„ÅÑÔºà„Åæ„Åü„ÅØAIÁîüÊàê‰∏≠„Åß„Å™„ÅÑÔºâÂ†¥Âêà„ÅÆ„Åø‰∏äÊõ∏„Åç„Åô„ÇãÂà∂Âæ°„ÇíÂÖ•„Çå„Çã„Å®„Çà„ÇäË¶™Âàá„Å†„Åå„ÄÅ
            // ‰ªäÂõû„ÅØ„ÄåÂÖ•Âäõ„ÅåÂ§â„Çè„Å£„Åü„ÇâÂç≥ÂèçÊò†„Äç„ÅÆ„Ç∑„É≥„Éó„É´„Åï„ÇíÂÑ™ÂÖà„Åó„ÄÅÂ∏∏„Å´‰∏äÊõ∏„Åç„Åô„Çã„ÄÇ
            // „Åü„Å†„Åó„ÄÅAIÁîüÊàêÂÆå‰∫ÜÁõ¥Âæå„ÅØ‰∏äÊõ∏„Åç„Åó„Åü„Åè„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Åù„Åì„ÅØhandleAIGenerateÂÅ¥„ÅßÂà∂Âæ°Ê∏à„Åø„ÄÇ
            document.getElementById('generatedText').value = fullText;
        }

        // „Åù„ÅÆ‰ªñÊ©üËÉΩ
        function toggleCustomInspection() {
            const val = document.getElementById('inspectionType').value;
            const wrapper = document.getElementById('customInspectionWrapper');
            val === '„Åù„ÅÆ‰ªñ' ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
        }

        function addCandidateDate() {
            const dateVal = document.getElementById('dateInput').value;
            const timeVal = document.getElementById('timeInput').value;
            if (!dateVal) return;
            const date = new Date(dateVal);
            const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            
            let formatted = `„Éª${date.getMonth() + 1}Êúà${date.getDate()}Êó•(${days[date.getDay()]}) ${timeVal}`;
            
            // ÁµÇ‰∫ÜÊôÇÈñì„Ç™„Éó„Ç∑„Éß„É≥
            const useEndTime = document.getElementById('useEndTime').checked;
            if(useEndTime) {
                const endTime = document.getElementById('endTimeInput').value;
                formatted += `ÔΩû${endTime}`;
            } else {
                formatted += `ÔΩû`;
            }

            const area = document.getElementById('candidateDates');
            area.value = area.value ? area.value.trim() + '\n' + formatted + '\n' : formatted + '\n';
            updatePreview();
            toggleClearBtn();
        }

        document.getElementById('dateInput').addEventListener('input', (e) => {
            const btn = document.getElementById('addBtn');
            btn.disabled = !e.target.value;
            if(!e.target.value) btn.classList.add('opacity-50', 'cursor-not-allowed');
            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });

        function toggleClearBtn() {
            const val = document.getElementById('candidateDates').value;
            const btn = document.getElementById('clearBtn');
            val ? btn.classList.remove('hidden') : btn.classList.add('hidden');
        }

        function clearCandidates() {
            document.getElementById('candidateDates').value = '';
            updatePreview();
            toggleClearBtn();
        }

        // „Ç≥„Éî„ÉºÊ©üËÉΩ
        function handleCopy() {
            const text = document.getElementById('generatedText').value;
            
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopiedState();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.warn('execCommand copy failed, trying Clipboard API', err);
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(showCopiedState)
                        .catch(e => {
                            console.error('Clipboard API failed', e);
                            alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        });
                }
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function showCopiedState() {
            const btn = document.getElementById('copyBtn');
            const btnText = document.getElementById('copyBtnText');
            btn.classList.add('bg-emerald-500', 'text-white', 'scale-110', 'ring-emerald-200');
            btn.classList.remove('from-pink-500', 'to-violet-600', 'ring-white/30');
            
            const icon = btn.querySelector('svg');
            icon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
            btnText.textContent = "COPIED!";
            
            setTimeout(() => {
                btn.classList.remove('bg-emerald-500', 'text-white', 'scale-110', 'ring-emerald-200');
                btn.classList.add('from-pink-500', 'to-violet-600', 'ring-white/30');
                icon.innerHTML = '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>'; 
                btnText.textContent = "COPY";
            }, 2000);
        }

        // ÂàùÊúüÂÆüË°å
        initTimeOptions();
        loadSettings();
        updatePreview();
    </script>
</body>
</html>
